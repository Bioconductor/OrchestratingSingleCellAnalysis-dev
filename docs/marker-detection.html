<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 11 Marker gene detection | Orchestrating Single-Cell Analysis with Bioconductor</title>
  <meta name="description" content="Or: how I learned to stop worrying and love the t-SNEs." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 11 Marker gene detection | Orchestrating Single-Cell Analysis with Bioconductor" />
  <meta property="og:type" content="book" />
  
  <meta property="og:image" content="https://www.bioconductor.org/images/logo_bioconductor.gif" />
  <meta property="og:description" content="Or: how I learned to stop worrying and love the t-SNEs." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 11 Marker gene detection | Orchestrating Single-Cell Analysis with Bioconductor" />
  
  <meta name="twitter:description" content="Or: how I learned to stop worrying and love the t-SNEs." />
  <meta name="twitter:image" content="https://www.bioconductor.org/images/logo_bioconductor.gif" />



<meta name="date" content="2020-08-17" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<link rel="prev" href="clustering.html"/>
<link rel="next" href="cell-type-annotation.html"/>
<script src="libs/header-attrs-2.3/header-attrs.js"></script>
<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Orchestrating Single-Cell Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Welcome</a></li>
<li class="part"><span><b>I Preamble</b></span></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a>
<ul>
<li class="chapter" data-level="1.1" data-path="introduction.html"><a href="introduction.html#what-you-will-learn"><i class="fa fa-check"></i><b>1.1</b> What you will learn</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path="introduction.html"><a href="introduction.html#preliminaries"><i class="fa fa-check"></i><b>1.1.1</b> Preliminaries</a></li>
<li class="chapter" data-level="1.1.2" data-path="introduction.html"><a href="introduction.html#workflows"><i class="fa fa-check"></i><b>1.1.2</b> Workflows</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path="introduction.html"><a href="introduction.html#what-you-wont-learn"><i class="fa fa-check"></i><b>1.2</b> What you won’t learn</a></li>
<li class="chapter" data-level="1.3" data-path="introduction.html"><a href="introduction.html#who-we-wrote-this-for"><i class="fa fa-check"></i><b>1.3</b> Who we wrote this for</a></li>
<li class="chapter" data-level="1.4" data-path="introduction.html"><a href="introduction.html#why-we-wrote-this"><i class="fa fa-check"></i><b>1.4</b> Why we wrote this</a></li>
<li class="chapter" data-level="1.5" data-path="introduction.html"><a href="introduction.html#acknowledgements"><i class="fa fa-check"></i><b>1.5</b> Acknowledgements</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html"><i class="fa fa-check"></i><b>2</b> Learning R and Bioconductor</a>
<ul>
<li class="chapter" data-level="2.1" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#the-benefits-of-r-and-bioconductor"><i class="fa fa-check"></i><b>2.1</b> The Benefits of R and Bioconductor</a></li>
<li class="chapter" data-level="2.2" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#getting-started-with-r"><i class="fa fa-check"></i><b>2.2</b> Learning R Online</a></li>
<li class="chapter" data-level="2.3" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#running-r-locally"><i class="fa fa-check"></i><b>2.3</b> Running R Locally</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#installing-r"><i class="fa fa-check"></i><b>2.3.1</b> Installing R</a></li>
<li class="chapter" data-level="2.3.2" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#installing-r-bioconductor-packages"><i class="fa fa-check"></i><b>2.3.2</b> Installing R &amp; Bioconductor Packages</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#getting-help-in-and-out-of-r"><i class="fa fa-check"></i><b>2.4</b> Getting Help In (and Out) of R</a></li>
<li class="chapter" data-level="2.5" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#bioconductor-documentation"><i class="fa fa-check"></i><b>2.5</b> Bioconductor Help</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#bioconductor-packages"><i class="fa fa-check"></i><b>2.5.1</b> Bioconductor Packages</a></li>
<li class="chapter" data-level="2.5.2" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#biocviews"><i class="fa fa-check"></i><b>2.5.2</b> biocViews</a></li>
<li class="chapter" data-level="2.5.3" data-path="learning-r-and-more.html"><a href="learning-r-and-more.html#bioconductor-forums"><i class="fa fa-check"></i><b>2.5.3</b> Bioconductor Forums</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html"><i class="fa fa-check"></i><b>3</b> Beyond R Basics</a>
<ul>
<li class="chapter" data-level="3.1" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html#becoming-an-r-expert"><i class="fa fa-check"></i><b>3.1</b> Becoming an R Expert</a></li>
<li class="chapter" data-level="3.2" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html#becoming-a-bioconductor-developer"><i class="fa fa-check"></i><b>3.2</b> Becoming an R/Bioconductor Developer</a></li>
<li class="chapter" data-level="3.3" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html#nice-companions-for-r"><i class="fa fa-check"></i><b>3.3</b> Nice Companions for R</a>
<ul>
<li class="chapter" data-level="3.3.1" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html#shellbash"><i class="fa fa-check"></i><b>3.3.1</b> Shell/Bash</a></li>
<li class="chapter" data-level="3.3.2" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html#git"><i class="fa fa-check"></i><b>3.3.2</b> Git</a></li>
<li class="chapter" data-level="3.3.3" data-path="beyond-r-basics.html"><a href="beyond-r-basics.html#other-languages"><i class="fa fa-check"></i><b>3.3.3</b> Other Languages</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="data-infrastructure.html"><a href="data-infrastructure.html"><i class="fa fa-check"></i><b>4</b> Data Infrastructure</a>
<ul>
<li class="chapter" data-level="4.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#background"><i class="fa fa-check"></i><b>4.1</b> Background</a></li>
<li class="chapter" data-level="4.2" data-path="data-infrastructure.html"><a href="data-infrastructure.html#storing-primary-experimental-data"><i class="fa fa-check"></i><b>4.2</b> Storing primary experimental data</a>
<ul>
<li class="chapter" data-level="4.2.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#filling-the-assays-slot"><i class="fa fa-check"></i><b>4.2.1</b> Filling the <code>assays</code> slot</a></li>
<li class="chapter" data-level="4.2.2" data-path="data-infrastructure.html"><a href="data-infrastructure.html#adding-more-assays"><i class="fa fa-check"></i><b>4.2.2</b> Adding more <code>assays</code></a></li>
</ul></li>
<li class="chapter" data-level="4.3" data-path="data-infrastructure.html"><a href="data-infrastructure.html#handling-metadata"><i class="fa fa-check"></i><b>4.3</b> Handling metadata</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#on-the-columns"><i class="fa fa-check"></i><b>4.3.1</b> On the columns</a></li>
<li class="chapter" data-level="4.3.2" data-path="data-infrastructure.html"><a href="data-infrastructure.html#on-the-rows"><i class="fa fa-check"></i><b>4.3.2</b> On the rows</a></li>
<li class="chapter" data-level="4.3.3" data-path="data-infrastructure.html"><a href="data-infrastructure.html#other-metadata"><i class="fa fa-check"></i><b>4.3.3</b> Other metadata</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="data-infrastructure.html"><a href="data-infrastructure.html#single-cell-specific-fields"><i class="fa fa-check"></i><b>4.4</b> Single-cell-specific fields</a>
<ul>
<li class="chapter" data-level="4.4.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#background-1"><i class="fa fa-check"></i><b>4.4.1</b> Background</a></li>
<li class="chapter" data-level="4.4.2" data-path="data-infrastructure.html"><a href="data-infrastructure.html#dimensionality-reduction-results"><i class="fa fa-check"></i><b>4.4.2</b> Dimensionality reduction results</a></li>
<li class="chapter" data-level="4.4.3" data-path="data-infrastructure.html"><a href="data-infrastructure.html#alternative-experiments"><i class="fa fa-check"></i><b>4.4.3</b> Alternative Experiments</a></li>
<li class="chapter" data-level="4.4.4" data-path="data-infrastructure.html"><a href="data-infrastructure.html#size-factors"><i class="fa fa-check"></i><b>4.4.4</b> Size factors</a></li>
<li class="chapter" data-level="4.4.5" data-path="data-infrastructure.html"><a href="data-infrastructure.html#column-labels"><i class="fa fa-check"></i><b>4.4.5</b> Column labels</a></li>
</ul></li>
<li class="chapter" data-level="4.5" data-path="data-infrastructure.html"><a href="data-infrastructure.html#conclusion"><i class="fa fa-check"></i><b>4.5</b> Conclusion</a></li>
</ul></li>
<li class="part"><span><b>II Focus Topics</b></span></li>
<li class="chapter" data-level="5" data-path="overview.html"><a href="overview.html"><i class="fa fa-check"></i><b>5</b> Overview</a>
<ul>
<li class="chapter" data-level="5.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>5.1</b> Introduction</a></li>
<li class="chapter" data-level="5.2" data-path="overview.html"><a href="overview.html#experimental-design"><i class="fa fa-check"></i><b>5.2</b> Experimental Design</a></li>
<li class="chapter" data-level="5.3" data-path="overview.html"><a href="overview.html#obtaining-a-count-matrix"><i class="fa fa-check"></i><b>5.3</b> Obtaining a count matrix</a></li>
<li class="chapter" data-level="5.4" data-path="overview.html"><a href="overview.html#data-processing-and-downstream-analysis"><i class="fa fa-check"></i><b>5.4</b> Data processing and downstream analysis</a></li>
<li class="chapter" data-level="5.5" data-path="overview.html"><a href="overview.html#quick-start"><i class="fa fa-check"></i><b>5.5</b> Quick start</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="quality-control.html"><a href="quality-control.html"><i class="fa fa-check"></i><b>6</b> Quality Control</a>
<ul>
<li class="chapter" data-level="6.1" data-path="quality-control.html"><a href="quality-control.html#quality-control-motivation"><i class="fa fa-check"></i><b>6.1</b> Motivation</a></li>
<li class="chapter" data-level="6.2" data-path="quality-control.html"><a href="quality-control.html#choice-of-qc-metrics"><i class="fa fa-check"></i><b>6.2</b> Choice of QC metrics</a></li>
<li class="chapter" data-level="6.3" data-path="quality-control.html"><a href="quality-control.html#identifying-low-quality-cells"><i class="fa fa-check"></i><b>6.3</b> Identifying low-quality cells</a>
<ul>
<li class="chapter" data-level="6.3.1" data-path="quality-control.html"><a href="quality-control.html#fixed-qc"><i class="fa fa-check"></i><b>6.3.1</b> With fixed thresholds</a></li>
<li class="chapter" data-level="6.3.2" data-path="quality-control.html"><a href="quality-control.html#quality-control-outlier"><i class="fa fa-check"></i><b>6.3.2</b> With adaptive thresholds</a></li>
<li class="chapter" data-level="6.3.3" data-path="quality-control.html"><a href="quality-control.html#other-approaches"><i class="fa fa-check"></i><b>6.3.3</b> Other approaches</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="quality-control.html"><a href="quality-control.html#quality-control-plots"><i class="fa fa-check"></i><b>6.4</b> Checking diagnostic plots</a></li>
<li class="chapter" data-level="6.5" data-path="quality-control.html"><a href="quality-control.html#quality-control-discarded"><i class="fa fa-check"></i><b>6.5</b> Removing low-quality cells</a></li>
<li class="chapter" data-level="6.6" data-path="quality-control.html"><a href="quality-control.html#marking-qc"><i class="fa fa-check"></i><b>6.6</b> Marking low-quality cells</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="normalization.html"><a href="normalization.html"><i class="fa fa-check"></i><b>7</b> Normalization</a>
<ul>
<li class="chapter" data-level="7.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>7.1</b> Motivation</a></li>
<li class="chapter" data-level="7.2" data-path="normalization.html"><a href="normalization.html#library-size-normalization"><i class="fa fa-check"></i><b>7.2</b> Library size normalization</a></li>
<li class="chapter" data-level="7.3" data-path="normalization.html"><a href="normalization.html#normalization-by-deconvolution"><i class="fa fa-check"></i><b>7.3</b> Normalization by deconvolution</a></li>
<li class="chapter" data-level="7.4" data-path="normalization.html"><a href="normalization.html#spike-norm"><i class="fa fa-check"></i><b>7.4</b> Normalization by spike-ins</a></li>
<li class="chapter" data-level="7.5" data-path="normalization.html"><a href="normalization.html#applying-the-size-factors"><i class="fa fa-check"></i><b>7.5</b> Applying the size factors</a>
<ul>
<li class="chapter" data-level="7.5.1" data-path="normalization.html"><a href="normalization.html#normalization-transformation"><i class="fa fa-check"></i><b>7.5.1</b> Scaling and log-transforming</a></li>
<li class="chapter" data-level="7.5.2" data-path="normalization.html"><a href="normalization.html#downsampling-and-log-transforming"><i class="fa fa-check"></i><b>7.5.2</b> Downsampling and log-transforming</a></li>
<li class="chapter" data-level="7.5.3" data-path="normalization.html"><a href="normalization.html#other-options"><i class="fa fa-check"></i><b>7.5.3</b> Other options</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="feature-selection.html"><a href="feature-selection.html"><i class="fa fa-check"></i><b>8</b> Feature selection</a>
<ul>
<li class="chapter" data-level="8.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>8.1</b> Motivation</a></li>
<li class="chapter" data-level="8.2" data-path="feature-selection.html"><a href="feature-selection.html#quantifying-per-gene-variation"><i class="fa fa-check"></i><b>8.2</b> Quantifying per-gene variation</a>
<ul>
<li class="chapter" data-level="8.2.1" data-path="feature-selection.html"><a href="feature-selection.html#variance-of-the-log-counts"><i class="fa fa-check"></i><b>8.2.1</b> Variance of the log-counts</a></li>
<li class="chapter" data-level="8.2.2" data-path="feature-selection.html"><a href="feature-selection.html#coefficient-of-variation"><i class="fa fa-check"></i><b>8.2.2</b> Coefficient of variation</a></li>
<li class="chapter" data-level="8.2.3" data-path="feature-selection.html"><a href="feature-selection.html#sec:spikeins"><i class="fa fa-check"></i><b>8.2.3</b> Quantifying technical noise</a></li>
<li class="chapter" data-level="8.2.4" data-path="feature-selection.html"><a href="feature-selection.html#accounting-for-blocking-factors"><i class="fa fa-check"></i><b>8.2.4</b> Accounting for blocking factors</a></li>
</ul></li>
<li class="chapter" data-level="8.3" data-path="feature-selection.html"><a href="feature-selection.html#hvg-selection"><i class="fa fa-check"></i><b>8.3</b> Selecting highly variable genes</a>
<ul>
<li class="chapter" data-level="8.3.1" data-path="overview.html"><a href="overview.html#overview"><i class="fa fa-check"></i><b>8.3.1</b> Overview</a></li>
<li class="chapter" data-level="8.3.2" data-path="feature-selection.html"><a href="feature-selection.html#based-on-the-largest-metrics"><i class="fa fa-check"></i><b>8.3.2</b> Based on the largest metrics</a></li>
<li class="chapter" data-level="8.3.3" data-path="feature-selection.html"><a href="feature-selection.html#based-on-significance"><i class="fa fa-check"></i><b>8.3.3</b> Based on significance</a></li>
<li class="chapter" data-level="8.3.4" data-path="feature-selection.html"><a href="feature-selection.html#feature-selection-positive"><i class="fa fa-check"></i><b>8.3.4</b> Keeping all genes above the trend</a></li>
</ul></li>
<li class="chapter" data-level="8.4" data-path="feature-selection.html"><a href="feature-selection.html#apriori-hvgs"><i class="fa fa-check"></i><b>8.4</b> Selecting <em>a priori</em> genes of interest</a></li>
<li class="chapter" data-level="8.5" data-path="feature-selection.html"><a href="feature-selection.html#feature-selection-subsetting"><i class="fa fa-check"></i><b>8.5</b> Putting it all together</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html"><i class="fa fa-check"></i><b>9</b> Dimensionality reduction</a>
<ul>
<li class="chapter" data-level="9.1" data-path="overview.html"><a href="overview.html#overview"><i class="fa fa-check"></i><b>9.1</b> Overview</a></li>
<li class="chapter" data-level="9.2" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#principal-components-analysis"><i class="fa fa-check"></i><b>9.2</b> Principal components analysis</a></li>
<li class="chapter" data-level="9.3" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#choosing-the-number-of-pcs"><i class="fa fa-check"></i><b>9.3</b> Choosing the number of PCs</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>9.3.1</b> Motivation</a></li>
<li class="chapter" data-level="9.3.2" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#using-the-elbow-point"><i class="fa fa-check"></i><b>9.3.2</b> Using the elbow point</a></li>
<li class="chapter" data-level="9.3.3" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#using-the-technical-noise"><i class="fa fa-check"></i><b>9.3.3</b> Using the technical noise</a></li>
<li class="chapter" data-level="9.3.4" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#based-on-population-structure"><i class="fa fa-check"></i><b>9.3.4</b> Based on population structure</a></li>
<li class="chapter" data-level="9.3.5" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#using-random-matrix-theory"><i class="fa fa-check"></i><b>9.3.5</b> Using random matrix theory</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction-for-visualization"><i class="fa fa-check"></i><b>9.4</b> Dimensionality reduction for visualization</a>
<ul>
<li class="chapter" data-level="9.4.1" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#motivation-1"><i class="fa fa-check"></i><b>9.4.1</b> Motivation</a></li>
<li class="chapter" data-level="9.4.2" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#visualizing-with-pca"><i class="fa fa-check"></i><b>9.4.2</b> Visualizing with PCA</a></li>
<li class="chapter" data-level="9.4.3" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#t-stochastic-neighbor-embedding"><i class="fa fa-check"></i><b>9.4.3</b> <span class="math inline">\(t\)</span>-stochastic neighbor embedding</a></li>
<li class="chapter" data-level="9.4.4" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#uniform-manifold-approximation-and-projection"><i class="fa fa-check"></i><b>9.4.4</b> Uniform manifold approximation and projection</a></li>
<li class="chapter" data-level="9.4.5" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#visualization-interpretation"><i class="fa fa-check"></i><b>9.4.5</b> Interpreting the plots</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="clustering.html"><a href="clustering.html"><i class="fa fa-check"></i><b>10</b> Clustering</a>
<ul>
<li class="chapter" data-level="10.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>10.1</b> Motivation</a></li>
<li class="chapter" data-level="10.2" data-path="clustering.html"><a href="clustering.html#what-is-the-true-clustering"><i class="fa fa-check"></i><b>10.2</b> What is the “true clustering”?</a></li>
<li class="chapter" data-level="10.3" data-path="clustering.html"><a href="clustering.html#clustering-graph"><i class="fa fa-check"></i><b>10.3</b> Graph-based clustering</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#background"><i class="fa fa-check"></i><b>10.3.1</b> Background</a></li>
<li class="chapter" data-level="10.3.2" data-path="clustering.html"><a href="clustering.html#implementation"><i class="fa fa-check"></i><b>10.3.2</b> Implementation</a></li>
<li class="chapter" data-level="10.3.3" data-path="clustering.html"><a href="clustering.html#other-parameters"><i class="fa fa-check"></i><b>10.3.3</b> Other parameters</a></li>
<li class="chapter" data-level="10.3.4" data-path="clustering.html"><a href="clustering.html#assessing-cluster-separation"><i class="fa fa-check"></i><b>10.3.4</b> Assessing cluster separation</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="clustering.html"><a href="clustering.html#k-means-clustering"><i class="fa fa-check"></i><b>10.4</b> <span class="math inline">\(k\)</span>-means clustering</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#background-1"><i class="fa fa-check"></i><b>10.4.1</b> Background</a></li>
<li class="chapter" data-level="10.4.2" data-path="clustering.html"><a href="clustering.html#base-implementation"><i class="fa fa-check"></i><b>10.4.2</b> Base implementation</a></li>
<li class="chapter" data-level="10.4.3" data-path="clustering.html"><a href="clustering.html#assessing-cluster-separation-1"><i class="fa fa-check"></i><b>10.4.3</b> Assessing cluster separation</a></li>
<li class="chapter" data-level="10.4.4" data-path="clustering.html"><a href="clustering.html#in-two-step-procedures"><i class="fa fa-check"></i><b>10.4.4</b> In two-step procedures</a></li>
</ul></li>
<li class="chapter" data-level="10.5" data-path="clustering.html"><a href="clustering.html#hierarchical-clustering"><i class="fa fa-check"></i><b>10.5</b> Hierarchical clustering</a>
<ul>
<li class="chapter" data-level="10.5.1" data-path="clustering.html"><a href="clustering.html#background-2"><i class="fa fa-check"></i><b>10.5.1</b> Background</a></li>
<li class="chapter" data-level="10.5.2" data-path="clustering.html"><a href="clustering.html#implementation-1"><i class="fa fa-check"></i><b>10.5.2</b> Implementation</a></li>
<li class="chapter" data-level="10.5.3" data-path="clustering.html"><a href="clustering.html#silhouette-width"><i class="fa fa-check"></i><b>10.5.3</b> Assessing cluster separation</a></li>
</ul></li>
<li class="chapter" data-level="10.6" data-path="clustering.html"><a href="clustering.html#general-purpose-cluster-diagnostics"><i class="fa fa-check"></i><b>10.6</b> General-purpose cluster diagnostics</a>
<ul>
<li class="chapter" data-level="10.6.1" data-path="clustering.html"><a href="clustering.html#cluster-separation-redux"><i class="fa fa-check"></i><b>10.6.1</b> Cluster separation, redux</a></li>
<li class="chapter" data-level="10.6.2" data-path="clustering.html"><a href="clustering.html#comparing-different-clusterings"><i class="fa fa-check"></i><b>10.6.2</b> Comparing different clusterings</a></li>
<li class="chapter" data-level="10.6.3" data-path="clustering.html"><a href="clustering.html#cluster-bootstrapping"><i class="fa fa-check"></i><b>10.6.3</b> Evaluating cluster stability</a></li>
</ul></li>
<li class="chapter" data-level="10.7" data-path="clustering.html"><a href="clustering.html#subclustering"><i class="fa fa-check"></i><b>10.7</b> Subclustering</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="marker-detection.html"><a href="marker-detection.html"><i class="fa fa-check"></i><b>11</b> Marker gene detection</a>
<ul>
<li class="chapter" data-level="11.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>11.1</b> Motivation</a></li>
<li class="chapter" data-level="11.2" data-path="marker-detection.html"><a href="marker-detection.html#pairwise-tests-between-clusters"><i class="fa fa-check"></i><b>11.2</b> Pairwise tests between clusters</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#motivation-1"><i class="fa fa-check"></i><b>11.2.1</b> Motivation</a></li>
<li class="chapter" data-level="11.2.2" data-path="marker-detection.html"><a href="marker-detection.html#combining-pairwise-statistics-per-cluster"><i class="fa fa-check"></i><b>11.2.2</b> Combining pairwise statistics per cluster</a></li>
<li class="chapter" data-level="11.2.3" data-path="marker-detection.html"><a href="marker-detection.html#using-the-log-fold-change"><i class="fa fa-check"></i><b>11.2.3</b> Using the log-fold change</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="marker-detection.html"><a href="marker-detection.html#marker-tests"><i class="fa fa-check"></i><b>11.3</b> Alternative testing regimes</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="marker-detection.html"><a href="marker-detection.html#using-the-wilcoxon-rank-sum-test"><i class="fa fa-check"></i><b>11.3.1</b> Using the Wilcoxon rank sum test</a></li>
<li class="chapter" data-level="11.3.2" data-path="marker-detection.html"><a href="marker-detection.html#using-a-binomial-test"><i class="fa fa-check"></i><b>11.3.2</b> Using a binomial test</a></li>
<li class="chapter" data-level="11.3.3" data-path="marker-detection.html"><a href="marker-detection.html#using-custom-de-methods"><i class="fa fa-check"></i><b>11.3.3</b> Using custom DE methods</a></li>
<li class="chapter" data-level="11.3.4" data-path="marker-detection.html"><a href="marker-detection.html#combining-multiple-marker-statistics"><i class="fa fa-check"></i><b>11.3.4</b> Combining multiple marker statistics</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="marker-detection.html"><a href="marker-detection.html#marker-batch"><i class="fa fa-check"></i><b>11.4</b> Handling blocking factors</a>
<ul>
<li class="chapter" data-level="11.4.1" data-path="marker-detection.html"><a href="marker-detection.html#using-the-block-argument"><i class="fa fa-check"></i><b>11.4.1</b> Using the <code>block=</code> argument</a></li>
<li class="chapter" data-level="11.4.2" data-path="marker-detection.html"><a href="marker-detection.html#using-the-design-argument"><i class="fa fa-check"></i><b>11.4.2</b> Using the <code>design=</code> argument</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="marker-detection.html"><a href="marker-detection.html#p-value-invalidity"><i class="fa fa-check"></i><b>11.5</b> Invalidity of <span class="math inline">\(p\)</span>-values</a>
<ul>
<li class="chapter" data-level="11.5.1" data-path="marker-detection.html"><a href="marker-detection.html#from-data-snooping"><i class="fa fa-check"></i><b>11.5.1</b> From data snooping</a></li>
<li class="chapter" data-level="11.5.2" data-path="marker-detection.html"><a href="marker-detection.html#false-replicates"><i class="fa fa-check"></i><b>11.5.2</b> Nature of replication</a></li>
</ul></li>
<li class="chapter" data-level="11.6" data-path="marker-detection.html"><a href="marker-detection.html#further-comments"><i class="fa fa-check"></i><b>11.6</b> Further comments</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html"><i class="fa fa-check"></i><b>12</b> Cell type annotation</a>
<ul>
<li class="chapter" data-level="12.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>12.1</b> Motivation</a></li>
<li class="chapter" data-level="12.2" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#assigning-cell-labels-from-reference-data"><i class="fa fa-check"></i><b>12.2</b> Assigning cell labels from reference data</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="overview.html"><a href="overview.html#overview"><i class="fa fa-check"></i><b>12.2.1</b> Overview</a></li>
<li class="chapter" data-level="12.2.2" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#using-existing-references"><i class="fa fa-check"></i><b>12.2.2</b> Using existing references</a></li>
<li class="chapter" data-level="12.2.3" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#using-custom-references"><i class="fa fa-check"></i><b>12.2.3</b> Using custom references</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#assigning-cell-labels-from-gene-sets"><i class="fa fa-check"></i><b>12.3</b> Assigning cell labels from gene sets</a></li>
<li class="chapter" data-level="12.4" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#assigning-cluster-labels-from-markers"><i class="fa fa-check"></i><b>12.4</b> Assigning cluster labels from markers</a></li>
<li class="chapter" data-level="12.5" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#computing-gene-set-activities"><i class="fa fa-check"></i><b>12.5</b> Computing gene set activities</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="integrating-datasets.html"><a href="integrating-datasets.html"><i class="fa fa-check"></i><b>13</b> Integrating Datasets</a>
<ul>
<li class="chapter" data-level="13.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>13.1</b> Motivation</a></li>
<li class="chapter" data-level="13.2" data-path="integrating-datasets.html"><a href="integrating-datasets.html#setting-up-the-data"><i class="fa fa-check"></i><b>13.2</b> Setting up the data</a></li>
<li class="chapter" data-level="13.3" data-path="integrating-datasets.html"><a href="integrating-datasets.html#batch-diagnosis"><i class="fa fa-check"></i><b>13.3</b> Diagnosing batch effects</a></li>
<li class="chapter" data-level="13.4" data-path="integrating-datasets.html"><a href="integrating-datasets.html#linear-regression"><i class="fa fa-check"></i><b>13.4</b> Linear regression</a></li>
<li class="chapter" data-level="13.5" data-path="integrating-datasets.html"><a href="integrating-datasets.html#performing-mnn-correction"><i class="fa fa-check"></i><b>13.5</b> Performing MNN correction</a>
<ul>
<li class="chapter" data-level="13.5.1" data-path="integrating-datasets.html"><a href="integrating-datasets.html#algorithm-overview"><i class="fa fa-check"></i><b>13.5.1</b> Algorithm overview</a></li>
<li class="chapter" data-level="13.5.2" data-path="integrating-datasets.html"><a href="integrating-datasets.html#application-to-the-pbmc-data"><i class="fa fa-check"></i><b>13.5.2</b> Application to the PBMC data</a></li>
<li class="chapter" data-level="13.5.3" data-path="integrating-datasets.html"><a href="integrating-datasets.html#correction-diagnostics"><i class="fa fa-check"></i><b>13.5.3</b> Correction diagnostics</a></li>
</ul></li>
<li class="chapter" data-level="13.6" data-path="integrating-datasets.html"><a href="integrating-datasets.html#preserving-biological-heterogeneity"><i class="fa fa-check"></i><b>13.6</b> Preserving biological heterogeneity</a>
<ul>
<li class="chapter" data-level="13.6.1" data-path="integrating-datasets.html"><a href="integrating-datasets.html#comparison-to-within-batch-clusters"><i class="fa fa-check"></i><b>13.6.1</b> Comparison to within-batch clusters</a></li>
<li class="chapter" data-level="13.6.2" data-path="integrating-datasets.html"><a href="integrating-datasets.html#integration-with-markers"><i class="fa fa-check"></i><b>13.6.2</b> Encouraging consistency with marker genes</a></li>
</ul></li>
<li class="chapter" data-level="13.7" data-path="integrating-datasets.html"><a href="integrating-datasets.html#using-corrected-values"><i class="fa fa-check"></i><b>13.7</b> Using the corrected values</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html"><i class="fa fa-check"></i><b>14</b> Multi-sample comparisons</a>
<ul>
<li class="chapter" data-level="14.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>14.1</b> Motivation</a></li>
<li class="chapter" data-level="14.2" data-path="integrating-datasets.html"><a href="integrating-datasets.html#setting-up-the-data"><i class="fa fa-check"></i><b>14.2</b> Setting up the data</a></li>
<li class="chapter" data-level="14.3" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#differential-expression-between-conditions"><i class="fa fa-check"></i><b>14.3</b> Differential expression between conditions</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#creating-pseudo-bulk-samples"><i class="fa fa-check"></i><b>14.3.1</b> Creating pseudo-bulk samples</a></li>
<li class="chapter" data-level="14.3.2" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#performing-the-de-analysis"><i class="fa fa-check"></i><b>14.3.2</b> Performing the DE analysis</a></li>
<li class="chapter" data-level="14.3.3" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#putting-it-all-together"><i class="fa fa-check"></i><b>14.3.3</b> Putting it all together</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#ambient-problems"><i class="fa fa-check"></i><b>14.4</b> Avoiding problems with ambient RNA</a>
<ul>
<li class="chapter" data-level="14.4.1" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#motivation-1"><i class="fa fa-check"></i><b>14.4.1</b> Motivation</a></li>
<li class="chapter" data-level="14.4.2" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#finding-affected-degs"><i class="fa fa-check"></i><b>14.4.2</b> Finding affected DEGs</a></li>
<li class="chapter" data-level="14.4.3" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#subtracting-ambient-counts"><i class="fa fa-check"></i><b>14.4.3</b> Subtracting ambient counts</a></li>
</ul></li>
<li class="chapter" data-level="14.5" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#differential-abundance"><i class="fa fa-check"></i><b>14.5</b> Differential abundance between conditions</a>
<ul>
<li class="chapter" data-level="14.5.1" data-path="overview.html"><a href="overview.html#overview"><i class="fa fa-check"></i><b>14.5.1</b> Overview</a></li>
<li class="chapter" data-level="14.5.2" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#performing-the-da-analysis"><i class="fa fa-check"></i><b>14.5.2</b> Performing the DA analysis</a></li>
<li class="chapter" data-level="14.5.3" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#composition-effects"><i class="fa fa-check"></i><b>14.5.3</b> Handling composition effects</a></li>
</ul></li>
<li class="chapter" data-level="14.6" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#comments-on-interpretation"><i class="fa fa-check"></i><b>14.6</b> Comments on interpretation</a>
<ul>
<li class="chapter" data-level="14.6.1" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#de-da-duality"><i class="fa fa-check"></i><b>14.6.1</b> DE or DA? Two sides of the same coin</a></li>
<li class="chapter" data-level="14.6.2" data-path="multi-sample-comparisons.html"><a href="multi-sample-comparisons.html#sacrificing-differences"><i class="fa fa-check"></i><b>14.6.2</b> Sacrificing biology by integration</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="droplet-processing.html"><a href="droplet-processing.html"><i class="fa fa-check"></i><b>15</b> Droplet processing</a>
<ul>
<li class="chapter" data-level="15.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>15.1</b> Motivation</a></li>
<li class="chapter" data-level="15.2" data-path="droplet-processing.html"><a href="droplet-processing.html#qc-droplets"><i class="fa fa-check"></i><b>15.2</b> Calling cells from empty droplets</a>
<ul>
<li class="chapter" data-level="15.2.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#background"><i class="fa fa-check"></i><b>15.2.1</b> Background</a></li>
<li class="chapter" data-level="15.2.2" data-path="droplet-processing.html"><a href="droplet-processing.html#testing-for-empty-droplets"><i class="fa fa-check"></i><b>15.2.2</b> Testing for empty droplets</a></li>
<li class="chapter" data-level="15.2.3" data-path="droplet-processing.html"><a href="droplet-processing.html#relationship-with-other-qc-metrics"><i class="fa fa-check"></i><b>15.2.3</b> Relationship with other QC metrics</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="doublet-detection.html"><a href="doublet-detection.html"><i class="fa fa-check"></i><b>16</b> Doublet detection</a>
<ul>
<li class="chapter" data-level="16.1" data-path="overview.html"><a href="overview.html#overview"><i class="fa fa-check"></i><b>16.1</b> Overview</a></li>
<li class="chapter" data-level="16.2" data-path="doublet-detection.html"><a href="doublet-detection.html#doublet-detection-with-clusters"><i class="fa fa-check"></i><b>16.2</b> Doublet detection with clusters</a></li>
<li class="chapter" data-level="16.3" data-path="doublet-detection.html"><a href="doublet-detection.html#doublet-simulation"><i class="fa fa-check"></i><b>16.3</b> Doublet detection by simulation</a></li>
<li class="chapter" data-level="16.4" data-path="doublet-detection.html"><a href="doublet-detection.html#doublet-detection-in-multiplexed-experiments"><i class="fa fa-check"></i><b>16.4</b> Doublet detection in multiplexed experiments</a>
<ul>
<li class="chapter" data-level="16.4.1" data-path="data-infrastructure.html"><a href="data-infrastructure.html#background"><i class="fa fa-check"></i><b>16.4.1</b> Background</a></li>
<li class="chapter" data-level="16.4.2" data-path="doublet-detection.html"><a href="doublet-detection.html#identifying-inter-sample-doublets"><i class="fa fa-check"></i><b>16.4.2</b> Identifying inter-sample doublets</a></li>
<li class="chapter" data-level="16.4.3" data-path="doublet-detection.html"><a href="doublet-detection.html#guilt-by-association-for-unmarked-doublets"><i class="fa fa-check"></i><b>16.4.3</b> Guilt by association for unmarked doublets</a></li>
</ul></li>
<li class="chapter" data-level="16.5" data-path="marker-detection.html"><a href="marker-detection.html#further-comments"><i class="fa fa-check"></i><b>16.5</b> Further comments</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html"><i class="fa fa-check"></i><b>17</b> Cell cycle assignment</a>
<ul>
<li class="chapter" data-level="17.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>17.1</b> Motivation</a></li>
<li class="chapter" data-level="17.2" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#using-the-cyclins"><i class="fa fa-check"></i><b>17.2</b> Using the cyclins</a></li>
<li class="chapter" data-level="17.3" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#using-reference-profiles"><i class="fa fa-check"></i><b>17.3</b> Using reference profiles</a></li>
<li class="chapter" data-level="17.4" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#using-the-cyclone-classifier"><i class="fa fa-check"></i><b>17.4</b> Using the <code>cyclone()</code> classifier</a></li>
<li class="chapter" data-level="17.5" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#removing-cell-cycle-effects"><i class="fa fa-check"></i><b>17.5</b> Removing cell cycle effects</a>
<ul>
<li class="chapter" data-level="17.5.1" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#comments"><i class="fa fa-check"></i><b>17.5.1</b> Comments</a></li>
<li class="chapter" data-level="17.5.2" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#with-linear-regression-and-friends"><i class="fa fa-check"></i><b>17.5.2</b> With linear regression and friends</a></li>
<li class="chapter" data-level="17.5.3" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#removing-cell-cycle-related-genes"><i class="fa fa-check"></i><b>17.5.3</b> Removing cell cycle-related genes</a></li>
<li class="chapter" data-level="17.5.4" data-path="cell-cycle-assignment.html"><a href="cell-cycle-assignment.html#using-contrastive-pca"><i class="fa fa-check"></i><b>17.5.4</b> Using contrastive PCA</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html"><i class="fa fa-check"></i><b>18</b> Trajectory Analysis</a>
<ul>
<li class="chapter" data-level="18.1" data-path="overview.html"><a href="overview.html#overview"><i class="fa fa-check"></i><b>18.1</b> Overview</a></li>
<li class="chapter" data-level="18.2" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#obtaining-pseudotime-orderings"><i class="fa fa-check"></i><b>18.2</b> Obtaining pseudotime orderings</a>
<ul>
<li class="chapter" data-level="18.2.1" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#overview-1"><i class="fa fa-check"></i><b>18.2.1</b> Overview</a></li>
<li class="chapter" data-level="18.2.2" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#cluster-based-minimum-spanning-tree"><i class="fa fa-check"></i><b>18.2.2</b> Cluster-based minimum spanning tree</a></li>
<li class="chapter" data-level="18.2.3" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#principal-curves"><i class="fa fa-check"></i><b>18.2.3</b> Principal curves</a></li>
</ul></li>
<li class="chapter" data-level="18.3" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#characterizing-trajectories"><i class="fa fa-check"></i><b>18.3</b> Characterizing trajectories</a>
<ul>
<li class="chapter" data-level="18.3.1" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#overview-2"><i class="fa fa-check"></i><b>18.3.1</b> Overview</a></li>
<li class="chapter" data-level="18.3.2" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#changes-along-a-trajectory"><i class="fa fa-check"></i><b>18.3.2</b> Changes along a trajectory</a></li>
<li class="chapter" data-level="18.3.3" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#changes-between-paths"><i class="fa fa-check"></i><b>18.3.3</b> Changes between paths</a></li>
<li class="chapter" data-level="18.3.4" data-path="marker-detection.html"><a href="marker-detection.html#further-comments"><i class="fa fa-check"></i><b>18.3.4</b> Further comments</a></li>
</ul></li>
<li class="chapter" data-level="18.4" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#finding-the-root"><i class="fa fa-check"></i><b>18.4</b> Finding the root</a>
<ul>
<li class="chapter" data-level="18.4.1" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#overview-3"><i class="fa fa-check"></i><b>18.4.1</b> Overview</a></li>
<li class="chapter" data-level="18.4.2" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#entropy-based-methods"><i class="fa fa-check"></i><b>18.4.2</b> Entropy-based methods</a></li>
<li class="chapter" data-level="18.4.3" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#rna-velocity"><i class="fa fa-check"></i><b>18.4.3</b> RNA velocity</a></li>
<li class="chapter" data-level="18.4.4" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#real-timepoints"><i class="fa fa-check"></i><b>18.4.4</b> Real timepoints</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="trajectory-analysis.html"><a href="trajectory-analysis.html#session-information"><i class="fa fa-check"></i>Session information</a></li>
</ul></li>
<li class="chapter" data-level="19" data-path="single-nuclei-rna-seq-processing.html"><a href="single-nuclei-rna-seq-processing.html"><i class="fa fa-check"></i><b>19</b> Single-nuclei RNA-seq processing</a>
<ul>
<li class="chapter" data-level="19.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>19.1</b> Introduction</a></li>
<li class="chapter" data-level="19.2" data-path="single-nuclei-rna-seq-processing.html"><a href="single-nuclei-rna-seq-processing.html#quality-control-for-stripped-nuclei"><i class="fa fa-check"></i><b>19.2</b> Quality control for stripped nuclei</a></li>
<li class="chapter" data-level="19.3" data-path="single-nuclei-rna-seq-processing.html"><a href="single-nuclei-rna-seq-processing.html#comments-on-downstream-analyses"><i class="fa fa-check"></i><b>19.3</b> Comments on downstream analyses</a></li>
<li class="chapter" data-level="19.4" data-path="single-nuclei-rna-seq-processing.html"><a href="single-nuclei-rna-seq-processing.html#tricks-with-ambient-contamination"><i class="fa fa-check"></i><b>19.4</b> Tricks with ambient contamination</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html"><i class="fa fa-check"></i><b>20</b> Integrating with protein abundance</a>
<ul>
<li class="chapter" data-level="20.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>20.1</b> Motivation</a></li>
<li class="chapter" data-level="20.2" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html#preprocessing"><i class="fa fa-check"></i><b>20.2</b> Preprocessing</a>
<ul>
<li class="chapter" data-level="20.2.1" data-path="integrating-datasets.html"><a href="integrating-datasets.html#setting-up-the-data"><i class="fa fa-check"></i><b>20.2.1</b> Setting up the data</a></li>
<li class="chapter" data-level="20.2.2" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>20.2.2</b> Quality control</a></li>
<li class="chapter" data-level="20.2.3" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>20.2.3</b> Normalization</a></li>
</ul></li>
<li class="chapter" data-level="20.3" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html#clustering-and-interpretation"><i class="fa fa-check"></i><b>20.3</b> Clustering and interpretation</a></li>
<li class="chapter" data-level="20.4" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html#integration-with-gene-expression-data"><i class="fa fa-check"></i><b>20.4</b> Integration with gene expression data</a>
<ul>
<li class="chapter" data-level="20.4.1" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html#by-subclustering"><i class="fa fa-check"></i><b>20.4.1</b> By subclustering</a></li>
<li class="chapter" data-level="20.4.2" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html#by-combined-clustering"><i class="fa fa-check"></i><b>20.4.2</b> By combined clustering</a></li>
<li class="chapter" data-level="20.4.3" data-path="integrating-with-protein-abundance.html"><a href="integrating-with-protein-abundance.html#by-differential-testing"><i class="fa fa-check"></i><b>20.4.3</b> By differential testing</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="21" data-path="repertoire-seq.html"><a href="repertoire-seq.html"><i class="fa fa-check"></i><b>21</b> Analyzing repertoire sequencing data</a>
<ul>
<li class="chapter" data-level="21.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>21.1</b> Motivation</a></li>
<li class="chapter" data-level="21.2" data-path="repertoire-seq.html"><a href="repertoire-seq.html#loading-the-tcr-repertoire"><i class="fa fa-check"></i><b>21.2</b> Loading the TCR repertoire</a></li>
<li class="chapter" data-level="21.3" data-path="repertoire-seq.html"><a href="repertoire-seq.html#leveraging-list-semantics"><i class="fa fa-check"></i><b>21.3</b> Leveraging <code>List</code> semantics</a></li>
<li class="chapter" data-level="21.4" data-path="repertoire-seq.html"><a href="repertoire-seq.html#converting-back-to-dataframes"><i class="fa fa-check"></i><b>21.4</b> Converting back to <code>DataFrame</code>s</a></li>
<li class="chapter" data-level="21.5" data-path="repertoire-seq.html"><a href="repertoire-seq.html#case-study-for-clonotype-analyses"><i class="fa fa-check"></i><b>21.5</b> Case study for clonotype analyses</a></li>
<li class="chapter" data-level="21.6" data-path="repertoire-seq.html"><a href="repertoire-seq.html#repeating-for-immunoglobulins"><i class="fa fa-check"></i><b>21.6</b> Repeating for immunoglobulins</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="22" data-path="interactive-sharing.html"><a href="interactive-sharing.html"><i class="fa fa-check"></i><b>22</b> Interactive data exploration</a>
<ul>
<li class="chapter" data-level="22.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>22.1</b> Motivation</a></li>
<li class="chapter" data-level="22.2" data-path="interactive-sharing.html"><a href="interactive-sharing.html#interactive-quickstart"><i class="fa fa-check"></i><b>22.2</b> Quick start</a></li>
<li class="chapter" data-level="22.3" data-path="interactive-sharing.html"><a href="interactive-sharing.html#isee-examples"><i class="fa fa-check"></i><b>22.3</b> Usage examples</a>
<ul>
<li class="chapter" data-level="22.3.1" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>22.3.1</b> Quality control</a></li>
<li class="chapter" data-level="22.3.2" data-path="interactive-sharing.html"><a href="interactive-sharing.html#annotation-of-cell-populations"><i class="fa fa-check"></i><b>22.3.2</b> Annotation of cell populations</a></li>
<li class="chapter" data-level="22.3.3" data-path="interactive-sharing.html"><a href="interactive-sharing.html#querying-features-of-interest"><i class="fa fa-check"></i><b>22.3.3</b> Querying features of interest</a></li>
</ul></li>
<li class="chapter" data-level="22.4" data-path="interactive-sharing.html"><a href="interactive-sharing.html#reproducible-visualizations"><i class="fa fa-check"></i><b>22.4</b> Reproducible visualizations</a></li>
<li class="chapter" data-level="22.5" data-path="interactive-sharing.html"><a href="interactive-sharing.html#dissemination"><i class="fa fa-check"></i><b>22.5</b> Dissemination of analysis results</a></li>
<li class="chapter" data-level="22.6" data-path="interactive-sharing.html"><a href="interactive-sharing.html#additional-resources"><i class="fa fa-check"></i><b>22.6</b> Additional resources</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="23" data-path="dealing-with-big-data.html"><a href="dealing-with-big-data.html"><i class="fa fa-check"></i><b>23</b> Dealing with big data</a>
<ul>
<li class="chapter" data-level="23.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>23.1</b> Motivation</a></li>
<li class="chapter" data-level="23.2" data-path="dealing-with-big-data.html"><a href="dealing-with-big-data.html#fast-approximations"><i class="fa fa-check"></i><b>23.2</b> Fast approximations</a>
<ul>
<li class="chapter" data-level="23.2.1" data-path="dealing-with-big-data.html"><a href="dealing-with-big-data.html#nearest-neighbor-searching"><i class="fa fa-check"></i><b>23.2.1</b> Nearest neighbor searching</a></li>
<li class="chapter" data-level="23.2.2" data-path="dealing-with-big-data.html"><a href="dealing-with-big-data.html#big-data-svd"><i class="fa fa-check"></i><b>23.2.2</b> Singular value decomposition</a></li>
</ul></li>
<li class="chapter" data-level="23.3" data-path="dealing-with-big-data.html"><a href="dealing-with-big-data.html#parallelization"><i class="fa fa-check"></i><b>23.3</b> Parallelization</a></li>
<li class="chapter" data-level="23.4" data-path="dealing-with-big-data.html"><a href="dealing-with-big-data.html#out-of-memory-representations"><i class="fa fa-check"></i><b>23.4</b> Out of memory representations</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="24" data-path="interoperability.html"><a href="interoperability.html"><i class="fa fa-check"></i><b>24</b> Interoperability</a>
<ul>
<li class="chapter" data-level="24.1" data-path="normalization.html"><a href="normalization.html#motivation"><i class="fa fa-check"></i><b>24.1</b> Motivation</a></li>
<li class="chapter" data-level="24.2" data-path="interoperability.html"><a href="interoperability.html#interchanging-with-seurat"><i class="fa fa-check"></i><b>24.2</b> Interchanging with <em>Seurat</em></a></li>
<li class="chapter" data-level="24.3" data-path="interoperability.html"><a href="interoperability.html#interchanging-with-scanpy"><i class="fa fa-check"></i><b>24.3</b> Interchanging with <em>scanpy</em></a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="part"><span><b>III Workflows</b></span></li>
<li class="chapter" data-level="25" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html"><i class="fa fa-check"></i><b>25</b> Lun 416B cell line (Smart-seq2)</a>
<ul>
<li class="chapter" data-level="25.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>25.1</b> Introduction</a></li>
<li class="chapter" data-level="25.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>25.2</b> Data loading</a></li>
<li class="chapter" data-level="25.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>25.3</b> Quality control</a></li>
<li class="chapter" data-level="25.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>25.4</b> Normalization</a></li>
<li class="chapter" data-level="25.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>25.5</b> Variance modelling</a></li>
<li class="chapter" data-level="25.6" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#batch-correction"><i class="fa fa-check"></i><b>25.6</b> Batch correction</a></li>
<li class="chapter" data-level="25.7" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>25.7</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="25.8" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>25.8</b> Clustering</a></li>
<li class="chapter" data-level="25.9" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#interpretation"><i class="fa fa-check"></i><b>25.9</b> Interpretation</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="26" data-path="zeisel-mouse-brain-strt-seq.html"><a href="zeisel-mouse-brain-strt-seq.html"><i class="fa fa-check"></i><b>26</b> Zeisel mouse brain (STRT-Seq)</a>
<ul>
<li class="chapter" data-level="26.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>26.1</b> Introduction</a></li>
<li class="chapter" data-level="26.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>26.2</b> Data loading</a></li>
<li class="chapter" data-level="26.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>26.3</b> Quality control</a></li>
<li class="chapter" data-level="26.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>26.4</b> Normalization</a></li>
<li class="chapter" data-level="26.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>26.5</b> Variance modelling</a></li>
<li class="chapter" data-level="26.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>26.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="26.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>26.7</b> Clustering</a></li>
<li class="chapter" data-level="26.8" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#interpretation"><i class="fa fa-check"></i><b>26.8</b> Interpretation</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="27" data-path="unfiltered-human-pbmcs-10x-genomics.html"><a href="unfiltered-human-pbmcs-10x-genomics.html"><i class="fa fa-check"></i><b>27</b> Unfiltered human PBMCs (10X Genomics)</a>
<ul>
<li class="chapter" data-level="27.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>27.1</b> Introduction</a></li>
<li class="chapter" data-level="27.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>27.2</b> Data loading</a></li>
<li class="chapter" data-level="27.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>27.3</b> Quality control</a></li>
<li class="chapter" data-level="27.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>27.4</b> Normalization</a></li>
<li class="chapter" data-level="27.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>27.5</b> Variance modelling</a></li>
<li class="chapter" data-level="27.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>27.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="27.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>27.7</b> Clustering</a></li>
<li class="chapter" data-level="27.8" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#interpretation"><i class="fa fa-check"></i><b>27.8</b> Interpretation</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="28" data-path="filtered-human-pbmcs-10x-genomics.html"><a href="filtered-human-pbmcs-10x-genomics.html"><i class="fa fa-check"></i><b>28</b> Filtered human PBMCs (10X Genomics)</a>
<ul>
<li class="chapter" data-level="28.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>28.1</b> Introduction</a></li>
<li class="chapter" data-level="28.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>28.2</b> Data loading</a></li>
<li class="chapter" data-level="28.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>28.3</b> Quality control</a></li>
<li class="chapter" data-level="28.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>28.4</b> Normalization</a></li>
<li class="chapter" data-level="28.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>28.5</b> Variance modelling</a></li>
<li class="chapter" data-level="28.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>28.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="28.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>28.7</b> Clustering</a></li>
<li class="chapter" data-level="28.8" data-path="filtered-human-pbmcs-10x-genomics.html"><a href="filtered-human-pbmcs-10x-genomics.html#data-integration"><i class="fa fa-check"></i><b>28.8</b> Data integration</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="29" data-path="human-pbmc-with-surface-proteins-10x-genomics.html"><a href="human-pbmc-with-surface-proteins-10x-genomics.html"><i class="fa fa-check"></i><b>29</b> Human PBMC with surface proteins (10X Genomics)</a>
<ul>
<li class="chapter" data-level="29.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>29.1</b> Introduction</a></li>
<li class="chapter" data-level="29.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>29.2</b> Data loading</a></li>
<li class="chapter" data-level="29.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>29.3</b> Quality control</a></li>
<li class="chapter" data-level="29.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>29.4</b> Normalization</a></li>
<li class="chapter" data-level="29.5" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>29.5</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="29.6" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>29.6</b> Clustering</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="30" data-path="grun-human-pancreas-cel-seq2.html"><a href="grun-human-pancreas-cel-seq2.html"><i class="fa fa-check"></i><b>30</b> Grun human pancreas (CEL-seq2)</a>
<ul>
<li class="chapter" data-level="30.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>30.1</b> Introduction</a></li>
<li class="chapter" data-level="30.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>30.2</b> Data loading</a></li>
<li class="chapter" data-level="30.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>30.3</b> Quality control</a></li>
<li class="chapter" data-level="30.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>30.4</b> Normalization</a></li>
<li class="chapter" data-level="30.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>30.5</b> Variance modelling</a></li>
<li class="chapter" data-level="30.6" data-path="filtered-human-pbmcs-10x-genomics.html"><a href="filtered-human-pbmcs-10x-genomics.html#data-integration"><i class="fa fa-check"></i><b>30.6</b> Data integration</a></li>
<li class="chapter" data-level="30.7" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>30.7</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="30.8" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>30.8</b> Clustering</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="31" data-path="muraro-human-pancreas-cel-seq.html"><a href="muraro-human-pancreas-cel-seq.html"><i class="fa fa-check"></i><b>31</b> Muraro human pancreas (CEL-seq)</a>
<ul>
<li class="chapter" data-level="31.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>31.1</b> Introduction</a></li>
<li class="chapter" data-level="31.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>31.2</b> Data loading</a></li>
<li class="chapter" data-level="31.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>31.3</b> Quality control</a></li>
<li class="chapter" data-level="31.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>31.4</b> Normalization</a></li>
<li class="chapter" data-level="31.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>31.5</b> Variance modelling</a></li>
<li class="chapter" data-level="31.6" data-path="filtered-human-pbmcs-10x-genomics.html"><a href="filtered-human-pbmcs-10x-genomics.html#data-integration"><i class="fa fa-check"></i><b>31.6</b> Data integration</a></li>
<li class="chapter" data-level="31.7" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>31.7</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="31.8" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>31.8</b> Clustering</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="32" data-path="lawlor-human-pancreas-smarter.html"><a href="lawlor-human-pancreas-smarter.html"><i class="fa fa-check"></i><b>32</b> Lawlor human pancreas (SMARTer)</a>
<ul>
<li class="chapter" data-level="32.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>32.1</b> Introduction</a></li>
<li class="chapter" data-level="32.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>32.2</b> Data loading</a></li>
<li class="chapter" data-level="32.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>32.3</b> Quality control</a></li>
<li class="chapter" data-level="32.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>32.4</b> Normalization</a></li>
<li class="chapter" data-level="32.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>32.5</b> Variance modelling</a></li>
<li class="chapter" data-level="32.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>32.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="32.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>32.7</b> Clustering</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="33" data-path="segerstolpe-human-pancreas-smart-seq2.html"><a href="segerstolpe-human-pancreas-smart-seq2.html"><i class="fa fa-check"></i><b>33</b> Segerstolpe human pancreas (Smart-seq2)</a>
<ul>
<li class="chapter" data-level="33.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>33.1</b> Introduction</a></li>
<li class="chapter" data-level="33.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>33.2</b> Data loading</a></li>
<li class="chapter" data-level="33.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>33.3</b> Quality control</a></li>
<li class="chapter" data-level="33.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>33.4</b> Normalization</a></li>
<li class="chapter" data-level="33.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>33.5</b> Variance modelling</a></li>
<li class="chapter" data-level="33.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>33.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="33.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>33.7</b> Clustering</a></li>
<li class="chapter" data-level="33.8" data-path="filtered-human-pbmcs-10x-genomics.html"><a href="filtered-human-pbmcs-10x-genomics.html#data-integration"><i class="fa fa-check"></i><b>33.8</b> Data integration</a></li>
<li class="chapter" data-level="33.9" data-path="segerstolpe-human-pancreas-smart-seq2.html"><a href="segerstolpe-human-pancreas-smart-seq2.html#segerstolpe-comparison"><i class="fa fa-check"></i><b>33.9</b> Multi-sample comparisons</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="34" data-path="merged-pancreas.html"><a href="merged-pancreas.html"><i class="fa fa-check"></i><b>34</b> Merged human pancreas datasets</a>
<ul>
<li class="chapter" data-level="34.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>34.1</b> Introduction</a></li>
<li class="chapter" data-level="34.2" data-path="merged-pancreas.html"><a href="merged-pancreas.html#the-good"><i class="fa fa-check"></i><b>34.2</b> The good</a></li>
<li class="chapter" data-level="34.3" data-path="merged-pancreas.html"><a href="merged-pancreas.html#the-bad"><i class="fa fa-check"></i><b>34.3</b> The bad</a></li>
<li class="chapter" data-level="34.4" data-path="merged-pancreas.html"><a href="merged-pancreas.html#the-ugly"><i class="fa fa-check"></i><b>34.4</b> The ugly</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="35" data-path="merged-hcsc.html"><a href="merged-hcsc.html"><i class="fa fa-check"></i><b>35</b> Grun mouse HSC (CEL-seq)</a>
<ul>
<li class="chapter" data-level="35.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>35.1</b> Introduction</a></li>
<li class="chapter" data-level="35.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>35.2</b> Data loading</a></li>
<li class="chapter" data-level="35.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>35.3</b> Quality control</a></li>
<li class="chapter" data-level="35.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>35.4</b> Normalization</a></li>
<li class="chapter" data-level="35.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>35.5</b> Variance modelling</a></li>
<li class="chapter" data-level="35.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>35.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="35.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>35.7</b> Clustering</a></li>
<li class="chapter" data-level="35.8" data-path="merged-hcsc.html"><a href="merged-hcsc.html#marker-gene-detection"><i class="fa fa-check"></i><b>35.8</b> Marker gene detection</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="36" data-path="nestorowa-mouse-hsc-smart-seq2.html"><a href="nestorowa-mouse-hsc-smart-seq2.html"><i class="fa fa-check"></i><b>36</b> Nestorowa mouse HSC (Smart-seq2)</a>
<ul>
<li class="chapter" data-level="36.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>36.1</b> Introduction</a></li>
<li class="chapter" data-level="36.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>36.2</b> Data loading</a></li>
<li class="chapter" data-level="36.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>36.3</b> Quality control</a></li>
<li class="chapter" data-level="36.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>36.4</b> Normalization</a></li>
<li class="chapter" data-level="36.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>36.5</b> Variance modelling</a></li>
<li class="chapter" data-level="36.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>36.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="36.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>36.7</b> Clustering</a></li>
<li class="chapter" data-level="36.8" data-path="merged-hcsc.html"><a href="merged-hcsc.html#marker-gene-detection"><i class="fa fa-check"></i><b>36.8</b> Marker gene detection</a></li>
<li class="chapter" data-level="36.9" data-path="cell-type-annotation.html"><a href="cell-type-annotation.html#cell-type-annotation"><i class="fa fa-check"></i><b>36.9</b> Cell type annotation</a></li>
<li class="chapter" data-level="36.10" data-path="nestorowa-mouse-hsc-smart-seq2.html"><a href="nestorowa-mouse-hsc-smart-seq2.html#miscellaneous-analyses"><i class="fa fa-check"></i><b>36.10</b> Miscellaneous analyses</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="37" data-path="pijuan-sala-chimeric-mouse-embryo-10x-genomics.html"><a href="pijuan-sala-chimeric-mouse-embryo-10x-genomics.html"><i class="fa fa-check"></i><b>37</b> Pijuan-Sala chimeric mouse embryo (10X Genomics)</a>
<ul>
<li class="chapter" data-level="37.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>37.1</b> Introduction</a></li>
<li class="chapter" data-level="37.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>37.2</b> Data loading</a></li>
<li class="chapter" data-level="37.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>37.3</b> Quality control</a></li>
<li class="chapter" data-level="37.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>37.4</b> Normalization</a></li>
<li class="chapter" data-level="37.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>37.5</b> Variance modelling</a></li>
<li class="chapter" data-level="37.6" data-path="pijuan-sala-chimeric-mouse-embryo-10x-genomics.html"><a href="pijuan-sala-chimeric-mouse-embryo-10x-genomics.html#merging"><i class="fa fa-check"></i><b>37.6</b> Merging</a></li>
<li class="chapter" data-level="37.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>37.7</b> Clustering</a></li>
<li class="chapter" data-level="37.8" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>37.8</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="chapter" data-level="38" data-path="bach-mouse-mammary-gland-10x-genomics.html"><a href="bach-mouse-mammary-gland-10x-genomics.html"><i class="fa fa-check"></i><b>38</b> Bach mouse mammary gland (10X Genomics)</a>
<ul>
<li class="chapter" data-level="38.1" data-path="introduction.html"><a href="introduction.html#introduction"><i class="fa fa-check"></i><b>38.1</b> Introduction</a></li>
<li class="chapter" data-level="38.2" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#data-loading"><i class="fa fa-check"></i><b>38.2</b> Data loading</a></li>
<li class="chapter" data-level="38.3" data-path="quality-control.html"><a href="quality-control.html#quality-control"><i class="fa fa-check"></i><b>38.3</b> Quality control</a></li>
<li class="chapter" data-level="38.4" data-path="normalization.html"><a href="normalization.html#normalization"><i class="fa fa-check"></i><b>38.4</b> Normalization</a></li>
<li class="chapter" data-level="38.5" data-path="lun-416b-cell-line-smart-seq2.html"><a href="lun-416b-cell-line-smart-seq2.html#variance-modelling"><i class="fa fa-check"></i><b>38.5</b> Variance modelling</a></li>
<li class="chapter" data-level="38.6" data-path="dimensionality-reduction.html"><a href="dimensionality-reduction.html#dimensionality-reduction"><i class="fa fa-check"></i><b>38.6</b> Dimensionality reduction</a></li>
<li class="chapter" data-level="38.7" data-path="clustering.html"><a href="clustering.html#clustering"><i class="fa fa-check"></i><b>38.7</b> Clustering</a></li>
<li class="chapter" data-level="" data-path="overview.html"><a href="overview.html#session-info"><i class="fa fa-check"></i>Session Info</a></li>
</ul></li>
<li class="part"><span><b>IV Appendix</b></span></li>
<li class="chapter" data-level="39" data-path="contributors.html"><a href="contributors.html"><i class="fa fa-check"></i><b>39</b> Contributors</a>
<ul>
<li><a href="contributors.html#aaron-lun-phd"><em>Aaron Lun, PhD</em></a></li>
<li><a href="contributors.html#robert-amezquita-phd"><em>Robert Amezquita, PhD</em></a></li>
<li><a href="contributors.html#stephanie-hicks-phd"><em>Stephanie Hicks, PhD</em></a></li>
<li><a href="contributors.html#raphael-gottardo-phd"><em>Raphael Gottardo, PhD</em></a></li>
<li class="chapter" data-level="" data-path="contributors.html"><a href="contributors.html#other-notable-entities"><i class="fa fa-check"></i>Other notable entities</a></li>
</ul></li>
<li class="chapter" data-level="40" data-path="bibliography.html"><a href="bibliography.html"><i class="fa fa-check"></i><b>40</b> Bibliography</a></li>
<li class="divider"></li>
<li><a href="https://bioconductor.org" target="blank">Published by Bioconductor</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Orchestrating Single-Cell Analysis with Bioconductor</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="marker-detection" class="section level1" number="11">
<h1><span class="header-section-number">Chapter 11</span> Marker gene detection</h1>
<script>
document.addEventListener("click", function (event) {
    if (event.target.classList.contains("rebook-collapse")) {
        event.target.classList.toggle("active");
        var content = event.target.nextElementSibling;
        if (content.style.display === "block") {
            content.style.display = "none";
        } else {
            content.style.display = "block";
        }
    }
})
</script>
<style>
.rebook-collapse {
  background-color: #eee;
  color: #444;
  cursor: pointer;
  padding: 18px;
  width: 100%;
  border: none;
  text-align: left;
  outline: none;
  font-size: 15px;
}

.rebook-content {
  padding: 0 18px;
  display: none;
  overflow: hidden;
  background-color: #f1f1f1;
}
</style>
<div id="motivation" class="section level2" number="11.1">
<h2><span class="header-section-number">11.1</span> Motivation</h2>
<p>To interpret our clustering results from Chapter <a href="clustering.html#clustering">10</a>, we identify the genes that drive separation between clusters.
These marker genes allow us to assign biological meaning to each cluster based on their functional annotation.
In the most obvious case, the marker genes for each cluster are <em>a priori</em> associated with particular cell types, allowing us to treat the clustering as a proxy for cell type identity.
The same principle can be applied to discover more subtle differences between clusters (e.g., changes in activation or differentiation state) based on the behavior of genes in the affected pathways.</p>
<p>Identification of marker genes is usually based around the retrospective detection of differential expression between clusters.
Genes that are more strongly DE are more likely to have caused separate clustering of cells in the first place.
Several different statistical tests are available to quantify the differences in expression profiles, and different approaches can be used to consolidate test results into a single ranking of genes for each cluster.
These choices parametrize the theoretical differences between the various marker detection strategies presented in this chapter.
We will demonstrate using the 10X PBMC dataset:</p>
<button class="rebook-collapse">
View history
</button>
<div class="rebook-content">
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="marker-detection.html#cb320-1" aria-hidden="true"></a><span class="co">#--- loading ---#</span></span>
<span id="cb320-2"><a href="marker-detection.html#cb320-2" aria-hidden="true"></a><span class="kw">library</span>(BiocFileCache)</span>
<span id="cb320-3"><a href="marker-detection.html#cb320-3" aria-hidden="true"></a>bfc &lt;-<span class="st"> </span><span class="kw">BiocFileCache</span>(<span class="st">&quot;raw_data&quot;</span>, <span class="dt">ask =</span> <span class="ot">FALSE</span>)</span>
<span id="cb320-4"><a href="marker-detection.html#cb320-4" aria-hidden="true"></a>raw.path &lt;-<span class="st"> </span><span class="kw">bfcrpath</span>(bfc, <span class="kw">file.path</span>(<span class="st">&quot;http://cf.10xgenomics.com/samples&quot;</span>,</span>
<span id="cb320-5"><a href="marker-detection.html#cb320-5" aria-hidden="true"></a>    <span class="st">&quot;cell-exp/2.1.0/pbmc4k/pbmc4k_raw_gene_bc_matrices.tar.gz&quot;</span>))</span>
<span id="cb320-6"><a href="marker-detection.html#cb320-6" aria-hidden="true"></a><span class="kw">untar</span>(raw.path, <span class="dt">exdir=</span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;pbmc4k&quot;</span>))</span>
<span id="cb320-7"><a href="marker-detection.html#cb320-7" aria-hidden="true"></a></span>
<span id="cb320-8"><a href="marker-detection.html#cb320-8" aria-hidden="true"></a><span class="kw">library</span>(DropletUtils)</span>
<span id="cb320-9"><a href="marker-detection.html#cb320-9" aria-hidden="true"></a>fname &lt;-<span class="st"> </span><span class="kw">file.path</span>(<span class="kw">tempdir</span>(), <span class="st">&quot;pbmc4k/raw_gene_bc_matrices/GRCh38&quot;</span>)</span>
<span id="cb320-10"><a href="marker-detection.html#cb320-10" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span><span class="kw">read10xCounts</span>(fname, <span class="dt">col.names=</span><span class="ot">TRUE</span>)</span>
<span id="cb320-11"><a href="marker-detection.html#cb320-11" aria-hidden="true"></a></span>
<span id="cb320-12"><a href="marker-detection.html#cb320-12" aria-hidden="true"></a><span class="co">#--- gene-annotation ---#</span></span>
<span id="cb320-13"><a href="marker-detection.html#cb320-13" aria-hidden="true"></a><span class="kw">library</span>(scater)</span>
<span id="cb320-14"><a href="marker-detection.html#cb320-14" aria-hidden="true"></a><span class="kw">rownames</span>(sce.pbmc) &lt;-<span class="st"> </span><span class="kw">uniquifyFeatureNames</span>(</span>
<span id="cb320-15"><a href="marker-detection.html#cb320-15" aria-hidden="true"></a>    <span class="kw">rowData</span>(sce.pbmc)<span class="op">$</span>ID, <span class="kw">rowData</span>(sce.pbmc)<span class="op">$</span>Symbol)</span>
<span id="cb320-16"><a href="marker-detection.html#cb320-16" aria-hidden="true"></a></span>
<span id="cb320-17"><a href="marker-detection.html#cb320-17" aria-hidden="true"></a><span class="kw">library</span>(EnsDb.Hsapiens.v86)</span>
<span id="cb320-18"><a href="marker-detection.html#cb320-18" aria-hidden="true"></a>location &lt;-<span class="st"> </span><span class="kw">mapIds</span>(EnsDb.Hsapiens.v86, <span class="dt">keys=</span><span class="kw">rowData</span>(sce.pbmc)<span class="op">$</span>ID, </span>
<span id="cb320-19"><a href="marker-detection.html#cb320-19" aria-hidden="true"></a>    <span class="dt">column=</span><span class="st">&quot;SEQNAME&quot;</span>, <span class="dt">keytype=</span><span class="st">&quot;GENEID&quot;</span>)</span>
<span id="cb320-20"><a href="marker-detection.html#cb320-20" aria-hidden="true"></a></span>
<span id="cb320-21"><a href="marker-detection.html#cb320-21" aria-hidden="true"></a><span class="co">#--- cell-detection ---#</span></span>
<span id="cb320-22"><a href="marker-detection.html#cb320-22" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">100</span>)</span>
<span id="cb320-23"><a href="marker-detection.html#cb320-23" aria-hidden="true"></a>e.out &lt;-<span class="st"> </span><span class="kw">emptyDrops</span>(<span class="kw">counts</span>(sce.pbmc))</span>
<span id="cb320-24"><a href="marker-detection.html#cb320-24" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span>sce.pbmc[,<span class="kw">which</span>(e.out<span class="op">$</span>FDR <span class="op">&lt;=</span><span class="st"> </span><span class="fl">0.001</span>)]</span>
<span id="cb320-25"><a href="marker-detection.html#cb320-25" aria-hidden="true"></a></span>
<span id="cb320-26"><a href="marker-detection.html#cb320-26" aria-hidden="true"></a><span class="co">#--- quality-control ---#</span></span>
<span id="cb320-27"><a href="marker-detection.html#cb320-27" aria-hidden="true"></a>stats &lt;-<span class="st"> </span><span class="kw">perCellQCMetrics</span>(sce.pbmc, <span class="dt">subsets=</span><span class="kw">list</span>(<span class="dt">Mito=</span><span class="kw">which</span>(location<span class="op">==</span><span class="st">&quot;MT&quot;</span>)))</span>
<span id="cb320-28"><a href="marker-detection.html#cb320-28" aria-hidden="true"></a>high.mito &lt;-<span class="st"> </span><span class="kw">isOutlier</span>(stats<span class="op">$</span>subsets_Mito_percent, <span class="dt">type=</span><span class="st">&quot;higher&quot;</span>)</span>
<span id="cb320-29"><a href="marker-detection.html#cb320-29" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span>sce.pbmc[,<span class="op">!</span>high.mito]</span>
<span id="cb320-30"><a href="marker-detection.html#cb320-30" aria-hidden="true"></a></span>
<span id="cb320-31"><a href="marker-detection.html#cb320-31" aria-hidden="true"></a><span class="co">#--- normalization ---#</span></span>
<span id="cb320-32"><a href="marker-detection.html#cb320-32" aria-hidden="true"></a><span class="kw">library</span>(scran)</span>
<span id="cb320-33"><a href="marker-detection.html#cb320-33" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1000</span>)</span>
<span id="cb320-34"><a href="marker-detection.html#cb320-34" aria-hidden="true"></a>clusters &lt;-<span class="st"> </span><span class="kw">quickCluster</span>(sce.pbmc)</span>
<span id="cb320-35"><a href="marker-detection.html#cb320-35" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span><span class="kw">computeSumFactors</span>(sce.pbmc, <span class="dt">cluster=</span>clusters)</span>
<span id="cb320-36"><a href="marker-detection.html#cb320-36" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce.pbmc)</span>
<span id="cb320-37"><a href="marker-detection.html#cb320-37" aria-hidden="true"></a></span>
<span id="cb320-38"><a href="marker-detection.html#cb320-38" aria-hidden="true"></a><span class="co">#--- variance-modelling ---#</span></span>
<span id="cb320-39"><a href="marker-detection.html#cb320-39" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1001</span>)</span>
<span id="cb320-40"><a href="marker-detection.html#cb320-40" aria-hidden="true"></a>dec.pbmc &lt;-<span class="st"> </span><span class="kw">modelGeneVarByPoisson</span>(sce.pbmc)</span>
<span id="cb320-41"><a href="marker-detection.html#cb320-41" aria-hidden="true"></a>top.pbmc &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec.pbmc, <span class="dt">prop=</span><span class="fl">0.1</span>)</span>
<span id="cb320-42"><a href="marker-detection.html#cb320-42" aria-hidden="true"></a></span>
<span id="cb320-43"><a href="marker-detection.html#cb320-43" aria-hidden="true"></a><span class="co">#--- dimensionality-reduction ---#</span></span>
<span id="cb320-44"><a href="marker-detection.html#cb320-44" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">10000</span>)</span>
<span id="cb320-45"><a href="marker-detection.html#cb320-45" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span><span class="kw">denoisePCA</span>(sce.pbmc, <span class="dt">subset.row=</span>top.pbmc, <span class="dt">technical=</span>dec.pbmc)</span>
<span id="cb320-46"><a href="marker-detection.html#cb320-46" aria-hidden="true"></a></span>
<span id="cb320-47"><a href="marker-detection.html#cb320-47" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">100000</span>)</span>
<span id="cb320-48"><a href="marker-detection.html#cb320-48" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(sce.pbmc, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb320-49"><a href="marker-detection.html#cb320-49" aria-hidden="true"></a></span>
<span id="cb320-50"><a href="marker-detection.html#cb320-50" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1000000</span>)</span>
<span id="cb320-51"><a href="marker-detection.html#cb320-51" aria-hidden="true"></a>sce.pbmc &lt;-<span class="st"> </span><span class="kw">runUMAP</span>(sce.pbmc, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>)</span>
<span id="cb320-52"><a href="marker-detection.html#cb320-52" aria-hidden="true"></a></span>
<span id="cb320-53"><a href="marker-detection.html#cb320-53" aria-hidden="true"></a><span class="co">#--- clustering ---#</span></span>
<span id="cb320-54"><a href="marker-detection.html#cb320-54" aria-hidden="true"></a>g &lt;-<span class="st"> </span><span class="kw">buildSNNGraph</span>(sce.pbmc, <span class="dt">k=</span><span class="dv">10</span>, <span class="dt">use.dimred =</span> <span class="st">&#39;PCA&#39;</span>)</span>
<span id="cb320-55"><a href="marker-detection.html#cb320-55" aria-hidden="true"></a>clust &lt;-<span class="st"> </span>igraph<span class="op">::</span><span class="kw">cluster_walktrap</span>(g)<span class="op">$</span>membership</span>
<span id="cb320-56"><a href="marker-detection.html#cb320-56" aria-hidden="true"></a><span class="kw">colLabels</span>(sce.pbmc) &lt;-<span class="st"> </span><span class="kw">factor</span>(clust)</span></code></pre></div>
</div>
<div class="sourceCode" id="cb321"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb321-1"><a href="marker-detection.html#cb321-1" aria-hidden="true"></a>sce.pbmc</span></code></pre></div>
<pre><code>## class: SingleCellExperiment 
## dim: 33694 3985 
## metadata(1): Samples
## assays(2): counts logcounts
## rownames(33694): RP11-34P13.3 FAM138A ... AC213203.1 FAM231B
## rowData names(2): ID Symbol
## colnames(3985): AAACCTGAGAAGGCCT-1 AAACCTGAGACAGACC-1 ...
##   TTTGTCAGTTAAGACA-1 TTTGTCATCCCAAGAT-1
## colData names(4): Sample Barcode sizeFactor label
## reducedDimNames(3): PCA TSNE UMAP
## altExpNames(0):</code></pre>
</div>
<div id="pairwise-tests-between-clusters" class="section level2" number="11.2">
<h2><span class="header-section-number">11.2</span> Pairwise tests between clusters</h2>
<div id="motivation-1" class="section level3" number="11.2.1">
<h3><span class="header-section-number">11.2.1</span> Motivation</h3>
<p>Our general strategy is to perform DE tests between pairs of clusters and then combine results into a single ranking of marker genes for each cluster.
We deliberately use pairwise comparisons rather than comparing each cluster to the average of all other cells; the latter approach is sensitive to the population composition, which introduces an element of unpredictability to the marker sets due to variation in cell type abundances.
(In the worst case, the presence of one subpopulation containing a majority of the cells will drive the selection of top markers for every other cluster, pushing out useful genes that can distinguish between the smaller subpopulations.)
Moreover, pairwise comparisons naturally provide more information to interpret of the utility of a marker, e.g., by providing log-fold changes to indicate which clusters are distinguished by each gene.</p>
<p>For this section, we will use the Welch <span class="math inline">\(t\)</span>-test to perform our DE testing between clusters.
This is an easy choice as it is quickly computed and has good statistical properties for large numbers of cells <span class="citation">(Soneson and Robinson <a href="#ref-soneson2018bias" role="doc-biblioref">2018</a>)</span>.
However, the same approach can also be applied with any pairwise statistical test, as discussed in Section <a href="marker-detection.html#marker-tests">11.3</a>.</p>
</div>
<div id="combining-pairwise-statistics-per-cluster" class="section level3" number="11.2.2">
<h3><span class="header-section-number">11.2.2</span> Combining pairwise statistics per cluster</h3>
<div id="looking-for-any-differences" class="section level4" number="11.2.2.1">
<h4><span class="header-section-number">11.2.2.1</span> Looking for any differences</h4>
<p>We perform pairwise <span class="math inline">\(t\)</span>-tests between clusters for each gene using the <code>findMarkers()</code> function, which returns a list of <code>DataFrame</code>s containing ranked candidate markers for each cluster.
The function will automatically retrieve the cluster identities from <code>sce.pbmc</code> using the <code>colLabels()</code> function, though we can easily specify other clustering schemes by explicitly supplying them via the <code>groups=</code> argument.</p>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="marker-detection.html#cb323-1" aria-hidden="true"></a><span class="kw">library</span>(scran)</span>
<span id="cb323-2"><a href="marker-detection.html#cb323-2" aria-hidden="true"></a>markers.pbmc &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc)</span>
<span id="cb323-3"><a href="marker-detection.html#cb323-3" aria-hidden="true"></a>markers.pbmc</span></code></pre></div>
<pre><code>## List of length 16
## names(16): 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16</code></pre>
<p>The default philosophy of <code>findMarkers()</code> is to identify a combination of marker genes that - together - uniquely define one cluster against the rest.
To this end, we collect the top DE genes from each pairwise comparison involving a particular cluster to assemble a set of candidate markers for that cluster.
We will demonstrate on cluster 7; the relevant <code>DataFrame</code> contains log<sub>2</sub>-fold changes of expression in cluster 7 over each other cluster, along with several statistics obtained by combining <span class="math inline">\(p\)</span>-values <span class="citation">(Simes <a href="#ref-simes1986improved" role="doc-biblioref">1986</a>)</span> across the pairwise comparisons involving 7.</p>
<div class="sourceCode" id="cb325"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb325-1"><a href="marker-detection.html#cb325-1" aria-hidden="true"></a>chosen &lt;-<span class="st"> &quot;7&quot;</span></span>
<span id="cb325-2"><a href="marker-detection.html#cb325-2" aria-hidden="true"></a>interesting &lt;-<span class="st"> </span>markers.pbmc[[chosen]]</span>
<span id="cb325-3"><a href="marker-detection.html#cb325-3" aria-hidden="true"></a><span class="kw">colnames</span>(interesting)</span></code></pre></div>
<pre><code>##  [1] &quot;Top&quot;           &quot;p.value&quot;       &quot;FDR&quot;           &quot;summary.logFC&quot;
##  [5] &quot;logFC.1&quot;       &quot;logFC.2&quot;       &quot;logFC.3&quot;       &quot;logFC.4&quot;      
##  [9] &quot;logFC.5&quot;       &quot;logFC.6&quot;       &quot;logFC.8&quot;       &quot;logFC.9&quot;      
## [13] &quot;logFC.10&quot;      &quot;logFC.11&quot;      &quot;logFC.12&quot;      &quot;logFC.13&quot;     
## [17] &quot;logFC.14&quot;      &quot;logFC.15&quot;      &quot;logFC.16&quot;</code></pre>
<p>Of particular interest is the <code>Top</code> field.
The set of genes with <code>Top</code> <span class="math inline">\(\le X\)</span> is the union of the top <span class="math inline">\(X\)</span> genes (ranked by <span class="math inline">\(p\)</span>-value) from each pairwise comparison involving cluster 7.
For example, the set of all genes with <code>Top</code> values of 1 contains the gene with the lowest <span class="math inline">\(p\)</span>-value from each comparison.
Similarly, the set of genes with <code>Top</code> values less than or equal to 10 contains the top 10 genes from each comparison.
The <code>Top</code> field represents <code>findMarkers()</code>’s approach to consolidating multiple pairwise comparisons into a single ranking for each cluster; each <code>DataFrame</code> produced by <code>findMarkers()</code> will order genes based on the <code>Top</code> value by default.</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="marker-detection.html#cb327-1" aria-hidden="true"></a>interesting[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 4 columns
##                Top      p.value          FDR summary.logFC
##          &lt;integer&gt;    &lt;numeric&gt;    &lt;numeric&gt;     &lt;numeric&gt;
## S100A4           1  2.59737e-38  1.27018e-36      -4.27560
## TAGLN2           1  8.65033e-28  2.44722e-26       5.07327
## FCGR3A           1  8.84356e-63  1.15048e-60      -3.07121
## GZMA             1 1.15392e-120 7.20000e-118      -1.92877
## HLA-DQA1         1  3.43640e-83  8.90663e-81      -3.54890
## TMSB4X           1  9.83227e-36  4.25820e-34       4.28970
## FCN1             1 1.74313e-239 9.78883e-236      -2.77594
## TRAC             1  0.00000e+00  0.00000e+00      -2.44793
## RPL17            1  2.95529e-71  5.18622e-69      -2.86310
## CD79A            1  0.00000e+00  0.00000e+00      -2.98030</code></pre>
<p>We use the <code>Top</code> field to identify a set of genes that is guaranteed to distinguish cluster 7 from any other cluster.
Here, we examine the top 6 genes from each pairwise comparison (Figure <a href="marker-detection.html#fig:heat-basic-pbmc">11.1</a>).
Some inspection of the most upregulated genes suggest that cluster 9 contains platelets or their precursors, based on the expression of platelet factor 4 (<em>PF4</em>) and pro-platelet basic protein (<em>PPBP</em>).</p>
<div class="sourceCode" id="cb329"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb329-1"><a href="marker-detection.html#cb329-1" aria-hidden="true"></a>best.set &lt;-<span class="st"> </span>interesting[interesting<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">6</span>,]</span>
<span id="cb329-2"><a href="marker-detection.html#cb329-2" aria-hidden="true"></a>logFCs &lt;-<span class="st"> </span><span class="kw">getMarkerEffects</span>(best.set)</span>
<span id="cb329-3"><a href="marker-detection.html#cb329-3" aria-hidden="true"></a></span>
<span id="cb329-4"><a href="marker-detection.html#cb329-4" aria-hidden="true"></a><span class="kw">library</span>(pheatmap)</span>
<span id="cb329-5"><a href="marker-detection.html#cb329-5" aria-hidden="true"></a><span class="kw">pheatmap</span>(logFCs, <span class="dt">breaks=</span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">length.out=</span><span class="dv">101</span>))</span></code></pre></div>
<div class="figure"><span id="fig:heat-basic-pbmc"></span>
<img src="marker-detection_files/figure-html/heat-basic-pbmc-1.png" alt="Heatmap of log-fold changes for cluster 7 over all other clusters. Colours are capped at -5 and 5 to preserve dynamic range." width="672" />
<p class="caption">
Figure 11.1: Heatmap of log-fold changes for cluster 7 over all other clusters. Colours are capped at -5 and 5 to preserve dynamic range.
</p>
</div>
<p>Each <code>DataFrame</code> also contains several other statistics that may be of interest.
The <code>summary.logFC</code> field provides a convenient summary of the direction and effect size for each gene, and is defined here as the log-fold change from the comparison with the lowest <span class="math inline">\(p\)</span>-value.
The <code>p.value</code> field contains the combined <span class="math inline">\(p\)</span>-value that is obtained by applying Simes’ method to the pairwise <span class="math inline">\(p\)</span>-values for each gene and represents the evidence against the joint null hypothesis, i.e., that the gene is not DE between cluster 7 and any other cluster.
Examination of these statistics permits a quick evaluation of the suitability of a candidate marker; if both of these metrics are poor (small log-fold change, large <span class="math inline">\(p\)</span>-value), the gene can most likely be dismissed.</p>
</div>
<div id="finding-cluster-specific-markers" class="section level4" number="11.2.2.2">
<h4><span class="header-section-number">11.2.2.2</span> Finding cluster-specific markers</h4>
<p>By default, <code>findMarkers()</code> will give a high ranking to genes that are differentially expressed in any pairwise comparison.
This is because a gene only needs a very low <span class="math inline">\(p\)</span>-value in a single pairwise comparison to achieve a low <code>Top</code> value.
A more stringent approach would only consider genes that are differentially expressed in all pairwise comparisons involving the cluster of interest.
To achieve this, we set <code>pval.type="all"</code> in <code>findMarkers()</code> to use an intersection-union test <span class="citation">(Berger and Hsu <a href="#ref-berger1996bioequivalence" role="doc-biblioref">1996</a>)</span> where the combined <span class="math inline">\(p\)</span>-value for each gene is the maximum of the <span class="math inline">\(p\)</span>-values from all pairwise comparisons.
A gene will only achieve a low combined <span class="math inline">\(p\)</span>-value if it is strongly DE in all comparisons to other clusters.</p>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="marker-detection.html#cb330-1" aria-hidden="true"></a><span class="co"># Set direction=&#39;up&#39; to only consider upregulated genes as potential markers.</span></span>
<span id="cb330-2"><a href="marker-detection.html#cb330-2" aria-hidden="true"></a>markers.pbmc.up3 &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">pval.type=</span><span class="st">&quot;all&quot;</span>, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb330-3"><a href="marker-detection.html#cb330-3" aria-hidden="true"></a>interesting.up3 &lt;-<span class="st"> </span>markers.pbmc.up3[[chosen]]</span>
<span id="cb330-4"><a href="marker-detection.html#cb330-4" aria-hidden="true"></a>interesting.up3[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 3 columns
##               p.value         FDR summary.logFC
##             &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## SDPR      2.86451e-23 9.65166e-19       5.49695
## NRGN      5.91075e-23 9.95784e-19       4.71034
## TAGLN2    4.41617e-21 4.95995e-17       3.61864
## PPBP      1.36171e-20 1.14703e-16       6.34717
## GNG11     1.23155e-19 8.29918e-16       5.35904
## HIST1H2AC 3.94013e-19 2.21265e-15       5.46400
## TUBB1     9.64049e-19 4.64038e-15       4.92204
## PF4       1.87045e-14 7.87785e-11       6.49672
## CLU       8.75900e-13 3.27918e-09       3.90273
## RGS18     8.88042e-12 2.99217e-08       3.63236</code></pre>
<p>This strategy will only report genes that are highly specific to the cluster of interest.
When it works, it can be highly effective as it generates a small focused set of candidate markers.
However, any gene that is expressed at the same level in two or more clusters will simply not be detected.
This is likely to discard many interesting genes, especially if the clusters are finely resolved with weak separation.
To give a concrete example, consider a mixed population of CD4<sup>+</sup>-only, CD8<sup>+</sup>-only, double-positive and double-negative T cells.
With <code>pval.type="all"</code>, neither <em>Cd4</em> or <em>Cd8</em> would be detected as subpopulation-specific markers because each gene is expressed in two subpopulations.
In comparison, <code>pval.type="any"</code> will detect both of these genes as they will be DE between at least one pair of subpopulations.</p>
</div>
<div id="balancing-stringency-and-generality" class="section level4" number="11.2.2.3">
<h4><span class="header-section-number">11.2.2.3</span> Balancing stringency and generality</h4>
<p>If <code>pval.type="all"</code> is too stringent yet <code>pval.type="any"</code> is too generous, a compromise is to set <code>pval.type="some"</code>.
For each gene, we apply the Holm-Bonferroni correction across its <span class="math inline">\(p\)</span>-values and take the middle-most value as the combined <span class="math inline">\(p\)</span>-value.
This effectively tests the global null hypothesis that at least 50% of the individual pairwise comparisons exhibit no DE.
We then rank the genes by their combined <span class="math inline">\(p\)</span>-values to obtain an ordered set of marker candidates.
The aim is to improve the conciseness of the top markers for defining a cluster while mitigating the risk of discarding useful genes that are not DE to all other clusters.
The downside is that taking this compromise position sacrifices the theoretical guarantees offered at the other two extremes.</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="marker-detection.html#cb332-1" aria-hidden="true"></a>markers.pbmc.up4 &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">pval.type=</span><span class="st">&quot;some&quot;</span>, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb332-2"><a href="marker-detection.html#cb332-2" aria-hidden="true"></a>interesting.up4 &lt;-<span class="st"> </span>markers.pbmc.up4[[chosen]]</span>
<span id="cb332-3"><a href="marker-detection.html#cb332-3" aria-hidden="true"></a>interesting.up4[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 3 columns
##               p.value         FDR summary.logFC
##             &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## PF4       5.23414e-32 1.76359e-27       6.86288
## TMSB4X    4.52854e-25 7.62923e-21       2.90202
## TAGLN2    2.31252e-24 2.59727e-20       4.88268
## NRGN      1.08964e-22 9.17861e-19       5.00827
## SDPR      2.47896e-22 1.67052e-18       5.60445
## PPBP      8.57360e-20 4.81465e-16       6.50103
## CCL5      5.66181e-19 2.72527e-15       5.30774
## GNG11     8.98381e-19 3.59373e-15       5.47403
## GPX1      9.59922e-19 3.59373e-15       4.86299
## HIST1H2AC 2.85071e-18 9.60519e-15       5.53275</code></pre>
<p>In both cases, a different method is used to compute the summary effect size compared to <code>pval.type="any"</code>.
For <code>pval.type="all"</code>, the summary log-fold change is defined as that corresponding to the pairwise comparison with the largest <span class="math inline">\(p\)</span>-value, while for <code>pval.type="some"</code>, it is defined as the log-fold change for the comparison with the middle-most <span class="math inline">\(p\)</span>-value.
This reflects the calculation of the combined <span class="math inline">\(p\)</span>-value and avoids focusing on genes with strong changes in only one comparison.</p>
</div>
</div>
<div id="using-the-log-fold-change" class="section level3" number="11.2.3">
<h3><span class="header-section-number">11.2.3</span> Using the log-fold change</h3>
<p>The default <code>findMarkers()</code> call considers both up- and downregulated genes to be potential markers.
However, downregulated genes are less appealing as markers as it is more difficult to interpret and experimentally validate an absence of expression.
To focus on up-regulated markers, we can instead perform a one-sided <span class="math inline">\(t\)</span>-test to identify genes that are upregulated in each cluster compared to the others.
This is achieved by setting <code>direction="up"</code> in the <code>findMarkers()</code> call.</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="marker-detection.html#cb334-1" aria-hidden="true"></a>markers.pbmc.up &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb334-2"><a href="marker-detection.html#cb334-2" aria-hidden="true"></a>interesting.up &lt;-<span class="st"> </span>markers.pbmc.up[[chosen]]</span>
<span id="cb334-3"><a href="marker-detection.html#cb334-3" aria-hidden="true"></a>interesting.up[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 4 columns
##              Top     p.value         FDR summary.logFC
##        &lt;integer&gt;   &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## TAGLN2         1 4.32517e-28 4.85774e-24       5.07327
## PF4            1 4.78929e-35 8.06851e-31       6.71811
## TMSB4X         1 4.91613e-36 1.65644e-31       4.28970
## NRGN           2 1.35810e-23 9.15195e-20       4.86347
## B2M            2 8.10863e-25 6.83030e-21       2.40365
## SDPR           3 2.32759e-23 1.30710e-19       5.54225
## GPX1           4 4.74597e-21 2.28444e-17       5.71604
## PPBP           5 8.85410e-21 3.31478e-17       6.41411
## ACTB           6 6.22981e-21 2.62384e-17       3.79868
## GNG11          6 9.05522e-20 3.05107e-16       5.48735</code></pre>
<p>The <span class="math inline">\(t\)</span>-test also allows us to specify a non-zero log-fold change as the null hypothesis.
This allows us to consider the magnitude of the log-fold change in our <span class="math inline">\(p\)</span>-value calculations, in a manner that is more rigorous than simply filtering directly on the log-fold changes <span class="citation">(McCarthy and Smyth <a href="#ref-mccarthy2009treat" role="doc-biblioref">2009</a>)</span>.
(Specifically, a simple threshold does not consider the variance and can enrich for genes that have both large log-fold changes and large variances.)
We perform this by setting <code>lfc=</code> in our <code>findMarkers()</code> call - when combined with <code>direction=</code>, this tests for genes with log-fold changes that are significantly greater than 1:</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="marker-detection.html#cb336-1" aria-hidden="true"></a>markers.pbmc.up2 &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>, <span class="dt">lfc=</span><span class="dv">1</span>)</span>
<span id="cb336-2"><a href="marker-detection.html#cb336-2" aria-hidden="true"></a>interesting.up2 &lt;-<span class="st"> </span>markers.pbmc.up2[[chosen]]</span>
<span id="cb336-3"><a href="marker-detection.html#cb336-3" aria-hidden="true"></a>interesting.up2[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 4 columns
##                 Top     p.value         FDR summary.logFC
##           &lt;integer&gt;   &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## TAGLN2            1 9.48392e-23 1.06517e-18       5.07327
## PF4               1 2.19317e-31 7.38966e-27       6.71811
## SDPR              2 5.42215e-20 4.56735e-16       5.54225
## TMSB4X            2 9.90003e-28 1.66786e-23       4.28970
## NRGN              3 9.24786e-20 6.23195e-16       4.95866
## GPX1              4 7.73653e-18 3.72392e-14       5.71604
## PPBP              4 5.53317e-18 3.10725e-14       6.51025
## GNG11             6 1.56486e-16 6.59079e-13       5.48735
## CCL5              6 2.72759e-16 1.02115e-12       5.39815
## HIST1H2AC         7 5.56042e-16 1.87353e-12       5.57765</code></pre>
<p>These two settings yield a more focused set of candidate marker genes that are upregulated in cluster 7 (Figure <a href="marker-detection.html#fig:heat-focused-pbmc">11.2</a>).</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="marker-detection.html#cb338-1" aria-hidden="true"></a>best.set &lt;-<span class="st"> </span>interesting.up2[interesting.up2<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>,]</span>
<span id="cb338-2"><a href="marker-detection.html#cb338-2" aria-hidden="true"></a>logFCs &lt;-<span class="st"> </span><span class="kw">getMarkerEffects</span>(best.set)</span>
<span id="cb338-3"><a href="marker-detection.html#cb338-3" aria-hidden="true"></a></span>
<span id="cb338-4"><a href="marker-detection.html#cb338-4" aria-hidden="true"></a><span class="kw">library</span>(pheatmap)</span>
<span id="cb338-5"><a href="marker-detection.html#cb338-5" aria-hidden="true"></a><span class="kw">pheatmap</span>(logFCs, <span class="dt">breaks=</span><span class="kw">seq</span>(<span class="op">-</span><span class="dv">5</span>, <span class="dv">5</span>, <span class="dt">length.out=</span><span class="dv">101</span>))</span></code></pre></div>
<div class="figure"><span id="fig:heat-focused-pbmc"></span>
<img src="marker-detection_files/figure-html/heat-focused-pbmc-1.png" alt="Heatmap of log-fold changes for cluster 7 over all other clusters. Colours are capped at -5 and 5 to preserve dynamic range." width="672" />
<p class="caption">
Figure 11.2: Heatmap of log-fold changes for cluster 7 over all other clusters. Colours are capped at -5 and 5 to preserve dynamic range.
</p>
</div>
<p>Of course, this increased stringency is not without cost.
If only upregulated genes are requested from <code>findMarkers()</code>, any cluster defined by downregulation of a marker gene will not contain that gene among the top set of features in its <code>DataFrame</code>.
This is occasionally relevant for subtypes or other states that are defined by low expression of particular genes<a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a>.
Similarly, setting an excessively high log-fold change threshold may discard otherwise useful genes.
For example, a gene upregulated in a small proportion of cells of a cluster will have a small log-fold change but can still be an effective marker if the focus is on specificity rather than sensitivity.</p>
</div>
</div>
<div id="marker-tests" class="section level2" number="11.3">
<h2><span class="header-section-number">11.3</span> Alternative testing regimes</h2>
<div id="using-the-wilcoxon-rank-sum-test" class="section level3" number="11.3.1">
<h3><span class="header-section-number">11.3.1</span> Using the Wilcoxon rank sum test</h3>
<p>The Wilcoxon rank sum test (also known as the Wilcoxon-Mann-Whitney test, or WMW test) is another widely used method for pairwise comparisons between groups of observations.
Its strength lies in the fact that it directly assesses separation between the expression distributions of different clusters.
The WMW test statistic is proportional to the area-under-the-curve (AUC), i.e., the concordance probability, which is the probability of a random cell from one cluster having higher expression than a random cell from another cluster.
In a pairwise comparison, AUCs of 1 or 0 indicate that the two clusters have perfectly separated expression distributions.
Thus, the WMW test directly addresses the most desirable property of a candidate marker gene, while the <span class="math inline">\(t\)</span> test only does so indirectly via the difference in the means and the intra-group variance.</p>
<p>We perform WMW tests by again using the <code>findMarkers()</code> function, this time with <code>test="wilcox"</code>.
This returns a list of <code>DataFrame</code>s containing ranked candidate markers for each cluster.
The <code>direction=</code>, <code>lfc=</code> and <code>pval.type=</code> arguments can be specified and have the same interpretation as described for <span class="math inline">\(t\)</span>-tests.
We demonstrate below by detecting upregulated genes in each cluster with <code>direction="up"</code>.</p>
<div class="sourceCode" id="cb339"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb339-1"><a href="marker-detection.html#cb339-1" aria-hidden="true"></a>markers.pbmc.wmw &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">test=</span><span class="st">&quot;wilcox&quot;</span>, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb339-2"><a href="marker-detection.html#cb339-2" aria-hidden="true"></a><span class="kw">names</span>(markers.pbmc.wmw)</span></code></pre></div>
<pre><code>##  [1] &quot;1&quot;  &quot;2&quot;  &quot;3&quot;  &quot;4&quot;  &quot;5&quot;  &quot;6&quot;  &quot;7&quot;  &quot;8&quot;  &quot;9&quot;  &quot;10&quot; &quot;11&quot; &quot;12&quot; &quot;13&quot; &quot;14&quot; &quot;15&quot;
## [16] &quot;16&quot;</code></pre>
<p>To explore the results in more detail, we focus on the <code>DataFrame</code> for cluster 7.
The interpretation of <code>Top</code> is the same as described for <span class="math inline">\(t\)</span>-tests, and Simes’ method is again used to combine <span class="math inline">\(p\)</span>-values across pairwise comparisons.
If we want more focused sets, we can also change <code>pval.type=</code> as previously described.</p>
<div class="sourceCode" id="cb341"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb341-1"><a href="marker-detection.html#cb341-1" aria-hidden="true"></a>interesting.wmw &lt;-<span class="st"> </span>markers.pbmc.wmw[[chosen]]</span>
<span id="cb341-2"><a href="marker-detection.html#cb341-2" aria-hidden="true"></a>interesting.wmw[<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## DataFrame with 10 rows and 4 columns
##                 Top      p.value          FDR summary.AUC
##           &lt;integer&gt;    &lt;numeric&gt;    &lt;numeric&gt;   &lt;numeric&gt;
## PF4               1 1.02312e-179 3.44731e-175    0.989080
## TMSB4X            1  3.14604e-29  1.20457e-26    0.998195
## SDPR              2 1.36598e-159 2.30126e-155    0.956221
## NRGN              2 2.77288e-142 1.86859e-138    0.966865
## TAGLN2            3  1.58373e-29  6.20491e-27    0.967680
## PPBP              3 1.35961e-147 1.52702e-143    0.934256
## GNG11             3 4.00798e-139 2.25075e-135    0.934030
## TUBB1             3 3.23282e-146 2.72317e-142    0.923386
## HIST1H2AC         5  2.49447e-97  5.60325e-94    0.932300
## B2M               5  3.15826e-25  9.85320e-23    0.968938</code></pre>
<p>The <code>DataFrame</code> contains the AUCs from comparing cluster 7 to every other cluster (Figure <a href="marker-detection.html#fig:heat-wmw-pbmc">11.3</a>).
A value greater than 0.5 indicates that the gene is upregulated in the current cluster compared to the other cluster,
while values less than 0.5 correspond to downregulation.
We would typically expect AUCs of 0.7-0.8 for a strongly upregulated candidate marker.</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="marker-detection.html#cb343-1" aria-hidden="true"></a>best.set &lt;-<span class="st"> </span>interesting.wmw[interesting.wmw<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>,]</span>
<span id="cb343-2"><a href="marker-detection.html#cb343-2" aria-hidden="true"></a>AUCs &lt;-<span class="st"> </span><span class="kw">getMarkerEffects</span>(best.set, <span class="dt">prefix=</span><span class="st">&quot;AUC&quot;</span>)</span>
<span id="cb343-3"><a href="marker-detection.html#cb343-3" aria-hidden="true"></a></span>
<span id="cb343-4"><a href="marker-detection.html#cb343-4" aria-hidden="true"></a><span class="kw">library</span>(pheatmap)</span>
<span id="cb343-5"><a href="marker-detection.html#cb343-5" aria-hidden="true"></a><span class="kw">pheatmap</span>(AUCs, <span class="dt">breaks=</span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="dt">length.out=</span><span class="dv">21</span>),</span>
<span id="cb343-6"><a href="marker-detection.html#cb343-6" aria-hidden="true"></a>    <span class="dt">color=</span>viridis<span class="op">::</span><span class="kw">viridis</span>(<span class="dv">21</span>))</span></code></pre></div>
<div class="figure"><span id="fig:heat-wmw-pbmc"></span>
<img src="marker-detection_files/figure-html/heat-wmw-pbmc-1.png" alt="Heatmap of AUCs for cluster 7 compared to all other clusters." width="672" />
<p class="caption">
Figure 11.3: Heatmap of AUCs for cluster 7 compared to all other clusters.
</p>
</div>
<p>One practical advantage of the WMW test over the Welch <span class="math inline">\(t\)</span>-test is that it is symmetric with respect to differences in the size of the groups being compared.
This means that, all else being equal, the top-ranked genes on each side of a DE comparison will have similar expression profiles regardless of the number of cells in each group.
In contrast, the <span class="math inline">\(t\)</span>-test will favor genes where the larger group has the higher relative variance as this increases the estimated degrees of freedom and decreases the resulting <span class="math inline">\(p\)</span>-value.
This can lead to unappealing rankings when the aim is to identify genes upregulated in smaller groups.
The WMW test is not completely immune to variance effects - for example, it will slightly favor detection of DEGs at low average abundance where the greater number of ties at zero deflates the approximate variance of the rank sum statistic - but this is relatively benign as the selected genes are still fairly interesting.
We observe both of these effects in a comparison between alpha and gamma cells in the human pancreas data set from <span class="citation">Lawlor et al. (<a href="#ref-lawlor2017singlecell" role="doc-biblioref">2017</a>)</span> (Figure <a href="marker-detection.html#fig:comparative-markers-tw">11.4</a>).</p>
<button class="rebook-collapse">
View history
</button>
<div class="rebook-content">
<div class="sourceCode" id="cb344"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb344-1"><a href="marker-detection.html#cb344-1" aria-hidden="true"></a><span class="co">#--- loading ---#</span></span>
<span id="cb344-2"><a href="marker-detection.html#cb344-2" aria-hidden="true"></a><span class="kw">library</span>(scRNAseq)</span>
<span id="cb344-3"><a href="marker-detection.html#cb344-3" aria-hidden="true"></a>sce.lawlor &lt;-<span class="st"> </span><span class="kw">LawlorPancreasData</span>()</span>
<span id="cb344-4"><a href="marker-detection.html#cb344-4" aria-hidden="true"></a></span>
<span id="cb344-5"><a href="marker-detection.html#cb344-5" aria-hidden="true"></a><span class="co">#--- gene-annotation ---#</span></span>
<span id="cb344-6"><a href="marker-detection.html#cb344-6" aria-hidden="true"></a><span class="kw">library</span>(AnnotationHub)</span>
<span id="cb344-7"><a href="marker-detection.html#cb344-7" aria-hidden="true"></a>edb &lt;-<span class="st"> </span><span class="kw">AnnotationHub</span>()[[<span class="st">&quot;AH73881&quot;</span>]]</span>
<span id="cb344-8"><a href="marker-detection.html#cb344-8" aria-hidden="true"></a>anno &lt;-<span class="st"> </span><span class="kw">select</span>(edb, <span class="dt">keys=</span><span class="kw">rownames</span>(sce.lawlor), <span class="dt">keytype=</span><span class="st">&quot;GENEID&quot;</span>, </span>
<span id="cb344-9"><a href="marker-detection.html#cb344-9" aria-hidden="true"></a>    <span class="dt">columns=</span><span class="kw">c</span>(<span class="st">&quot;SYMBOL&quot;</span>, <span class="st">&quot;SEQNAME&quot;</span>))</span>
<span id="cb344-10"><a href="marker-detection.html#cb344-10" aria-hidden="true"></a><span class="kw">rowData</span>(sce.lawlor) &lt;-<span class="st"> </span>anno[<span class="kw">match</span>(<span class="kw">rownames</span>(sce.lawlor), anno[,<span class="dv">1</span>]),<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb344-11"><a href="marker-detection.html#cb344-11" aria-hidden="true"></a></span>
<span id="cb344-12"><a href="marker-detection.html#cb344-12" aria-hidden="true"></a><span class="co">#--- quality-control ---#</span></span>
<span id="cb344-13"><a href="marker-detection.html#cb344-13" aria-hidden="true"></a><span class="kw">library</span>(scater)</span>
<span id="cb344-14"><a href="marker-detection.html#cb344-14" aria-hidden="true"></a>stats &lt;-<span class="st"> </span><span class="kw">perCellQCMetrics</span>(sce.lawlor, </span>
<span id="cb344-15"><a href="marker-detection.html#cb344-15" aria-hidden="true"></a>    <span class="dt">subsets=</span><span class="kw">list</span>(<span class="dt">Mito=</span><span class="kw">which</span>(<span class="kw">rowData</span>(sce.lawlor)<span class="op">$</span>SEQNAME<span class="op">==</span><span class="st">&quot;MT&quot;</span>)))</span>
<span id="cb344-16"><a href="marker-detection.html#cb344-16" aria-hidden="true"></a>qc &lt;-<span class="st"> </span><span class="kw">quickPerCellQC</span>(stats, <span class="dt">percent_subsets=</span><span class="st">&quot;subsets_Mito_percent&quot;</span>,</span>
<span id="cb344-17"><a href="marker-detection.html#cb344-17" aria-hidden="true"></a>    <span class="dt">batch=</span>sce.lawlor<span class="op">$</span><span class="st">`</span><span class="dt">islet unos id</span><span class="st">`</span>)</span>
<span id="cb344-18"><a href="marker-detection.html#cb344-18" aria-hidden="true"></a>sce.lawlor &lt;-<span class="st"> </span>sce.lawlor[,<span class="op">!</span>qc<span class="op">$</span>discard]</span>
<span id="cb344-19"><a href="marker-detection.html#cb344-19" aria-hidden="true"></a></span>
<span id="cb344-20"><a href="marker-detection.html#cb344-20" aria-hidden="true"></a><span class="co">#--- normalization ---#</span></span>
<span id="cb344-21"><a href="marker-detection.html#cb344-21" aria-hidden="true"></a><span class="kw">library</span>(scran)</span>
<span id="cb344-22"><a href="marker-detection.html#cb344-22" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1000</span>)</span>
<span id="cb344-23"><a href="marker-detection.html#cb344-23" aria-hidden="true"></a>clusters &lt;-<span class="st"> </span><span class="kw">quickCluster</span>(sce.lawlor)</span>
<span id="cb344-24"><a href="marker-detection.html#cb344-24" aria-hidden="true"></a>sce.lawlor &lt;-<span class="st"> </span><span class="kw">computeSumFactors</span>(sce.lawlor, <span class="dt">clusters=</span>clusters)</span>
<span id="cb344-25"><a href="marker-detection.html#cb344-25" aria-hidden="true"></a>sce.lawlor &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce.lawlor)</span></code></pre></div>
</div>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="marker-detection.html#cb345-1" aria-hidden="true"></a>marker.lawlor.t &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.lawlor, <span class="dt">groups=</span>sce.lawlor<span class="op">$</span><span class="st">`</span><span class="dt">cell type</span><span class="st">`</span>, </span>
<span id="cb345-2"><a href="marker-detection.html#cb345-2" aria-hidden="true"></a>    <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>, <span class="dt">restrict=</span><span class="kw">c</span>(<span class="st">&quot;Alpha&quot;</span>, <span class="st">&quot;Gamma/PP&quot;</span>))</span>
<span id="cb345-3"><a href="marker-detection.html#cb345-3" aria-hidden="true"></a>marker.lawlor.w &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.lawlor, <span class="dt">groups=</span>sce.lawlor<span class="op">$</span><span class="st">`</span><span class="dt">cell type</span><span class="st">`</span>, </span>
<span id="cb345-4"><a href="marker-detection.html#cb345-4" aria-hidden="true"></a>    <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>, <span class="dt">restrict=</span><span class="kw">c</span>(<span class="st">&quot;Alpha&quot;</span>, <span class="st">&quot;Gamma/PP&quot;</span>), <span class="dt">test.type=</span><span class="st">&quot;wilcox&quot;</span>)</span>
<span id="cb345-5"><a href="marker-detection.html#cb345-5" aria-hidden="true"></a></span>
<span id="cb345-6"><a href="marker-detection.html#cb345-6" aria-hidden="true"></a><span class="co"># Upregulated in alpha:</span></span>
<span id="cb345-7"><a href="marker-detection.html#cb345-7" aria-hidden="true"></a>marker.alpha.t &lt;-<span class="st"> </span>marker.lawlor.t<span class="op">$</span>Alpha</span>
<span id="cb345-8"><a href="marker-detection.html#cb345-8" aria-hidden="true"></a>marker.alpha.w &lt;-<span class="st"> </span>marker.lawlor.w<span class="op">$</span>Alpha</span>
<span id="cb345-9"><a href="marker-detection.html#cb345-9" aria-hidden="true"></a>chosen.alpha.t &lt;-<span class="st"> </span><span class="kw">rownames</span>(marker.alpha.t)[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span>
<span id="cb345-10"><a href="marker-detection.html#cb345-10" aria-hidden="true"></a>chosen.alpha.w &lt;-<span class="st"> </span><span class="kw">rownames</span>(marker.alpha.w)[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span>
<span id="cb345-11"><a href="marker-detection.html#cb345-11" aria-hidden="true"></a>u.alpha.t &lt;-<span class="st"> </span><span class="kw">setdiff</span>(chosen.alpha.t, chosen.alpha.w)</span>
<span id="cb345-12"><a href="marker-detection.html#cb345-12" aria-hidden="true"></a>u.alpha.w &lt;-<span class="st"> </span><span class="kw">setdiff</span>(chosen.alpha.w, chosen.alpha.t)</span>
<span id="cb345-13"><a href="marker-detection.html#cb345-13" aria-hidden="true"></a></span>
<span id="cb345-14"><a href="marker-detection.html#cb345-14" aria-hidden="true"></a><span class="co"># Upregulated in gamma:</span></span>
<span id="cb345-15"><a href="marker-detection.html#cb345-15" aria-hidden="true"></a>marker.gamma.t &lt;-<span class="st"> </span>marker.lawlor.t<span class="op">$</span><span class="st">`</span><span class="dt">Gamma/PP</span><span class="st">`</span></span>
<span id="cb345-16"><a href="marker-detection.html#cb345-16" aria-hidden="true"></a>marker.gamma.w &lt;-<span class="st"> </span>marker.lawlor.w<span class="op">$</span><span class="st">`</span><span class="dt">Gamma/PP</span><span class="st">`</span></span>
<span id="cb345-17"><a href="marker-detection.html#cb345-17" aria-hidden="true"></a>chosen.gamma.t &lt;-<span class="st"> </span><span class="kw">rownames</span>(marker.gamma.t)[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span>
<span id="cb345-18"><a href="marker-detection.html#cb345-18" aria-hidden="true"></a>chosen.gamma.w &lt;-<span class="st"> </span><span class="kw">rownames</span>(marker.gamma.w)[<span class="dv">1</span><span class="op">:</span><span class="dv">20</span>]</span>
<span id="cb345-19"><a href="marker-detection.html#cb345-19" aria-hidden="true"></a>u.gamma.t &lt;-<span class="st"> </span><span class="kw">setdiff</span>(chosen.gamma.t, chosen.gamma.w)</span>
<span id="cb345-20"><a href="marker-detection.html#cb345-20" aria-hidden="true"></a>u.gamma.w &lt;-<span class="st"> </span><span class="kw">setdiff</span>(chosen.gamma.w, chosen.gamma.t)</span>
<span id="cb345-21"><a href="marker-detection.html#cb345-21" aria-hidden="true"></a></span>
<span id="cb345-22"><a href="marker-detection.html#cb345-22" aria-hidden="true"></a><span class="co"># Examining all uniquely detected markers in each direction.</span></span>
<span id="cb345-23"><a href="marker-detection.html#cb345-23" aria-hidden="true"></a><span class="kw">library</span>(scater)</span>
<span id="cb345-24"><a href="marker-detection.html#cb345-24" aria-hidden="true"></a>subset &lt;-<span class="st"> </span>sce.lawlor[,sce.lawlor<span class="op">$</span><span class="st">`</span><span class="dt">cell type</span><span class="st">`</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Alpha&quot;</span>, <span class="st">&quot;Gamma/PP&quot;</span>)]</span>
<span id="cb345-25"><a href="marker-detection.html#cb345-25" aria-hidden="true"></a>gridExtra<span class="op">::</span><span class="kw">grid.arrange</span>(</span>
<span id="cb345-26"><a href="marker-detection.html#cb345-26" aria-hidden="true"></a>    <span class="kw">plotExpression</span>(subset, <span class="dt">x=</span><span class="st">&quot;cell type&quot;</span>, <span class="dt">features=</span>u.alpha.t, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb345-27"><a href="marker-detection.html#cb345-27" aria-hidden="true"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="st">&quot;Upregulated in alpha, t-test-only&quot;</span>),</span>
<span id="cb345-28"><a href="marker-detection.html#cb345-28" aria-hidden="true"></a>    <span class="kw">plotExpression</span>(subset, <span class="dt">x=</span><span class="st">&quot;cell type&quot;</span>, <span class="dt">features=</span>u.alpha.w, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb345-29"><a href="marker-detection.html#cb345-29" aria-hidden="true"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="st">&quot;Upregulated in alpha, WMW-test-only&quot;</span>),</span>
<span id="cb345-30"><a href="marker-detection.html#cb345-30" aria-hidden="true"></a>    <span class="kw">plotExpression</span>(subset, <span class="dt">x=</span><span class="st">&quot;cell type&quot;</span>, <span class="dt">features=</span>u.gamma.t, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb345-31"><a href="marker-detection.html#cb345-31" aria-hidden="true"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="st">&quot;Upregulated in gamma, t-test-only&quot;</span>),</span>
<span id="cb345-32"><a href="marker-detection.html#cb345-32" aria-hidden="true"></a>    <span class="kw">plotExpression</span>(subset, <span class="dt">x=</span><span class="st">&quot;cell type&quot;</span>, <span class="dt">features=</span>u.gamma.w, <span class="dt">ncol=</span><span class="dv">2</span>) <span class="op">+</span></span>
<span id="cb345-33"><a href="marker-detection.html#cb345-33" aria-hidden="true"></a><span class="st">        </span><span class="kw">ggtitle</span>(<span class="st">&quot;Upregulated in gamma, WMW-test-only&quot;</span>),</span>
<span id="cb345-34"><a href="marker-detection.html#cb345-34" aria-hidden="true"></a>    <span class="dt">ncol=</span><span class="dv">2</span></span>
<span id="cb345-35"><a href="marker-detection.html#cb345-35" aria-hidden="true"></a>)</span></code></pre></div>
<div class="figure"><span id="fig:comparative-markers-tw"></span>
<img src="marker-detection_files/figure-html/comparative-markers-tw-1.png" alt="Distribution of expression values for alpha or gamma cell-specific markers in the GSE86469 human pancreas dataset. Each panel focuses on the genes that were uniquely ranked in the top 20 candidate markers by either the t-test or WMW test." width="672" />
<p class="caption">
Figure 11.4: Distribution of expression values for alpha or gamma cell-specific markers in the GSE86469 human pancreas dataset. Each panel focuses on the genes that were uniquely ranked in the top 20 candidate markers by either the t-test or WMW test.
</p>
</div>
<p>The main disadvantage of the WMW test is that the AUCs are much slower to compute compared to <span class="math inline">\(t\)</span>-statistics.
This may be inconvenient for interactive analyses involving multiple iterations of marker detection.
We can mitigate this to some extent by parallelizing these calculations using the <code>BPPARAM=</code> argument in <code>findMarkers()</code>.</p>
</div>
<div id="using-a-binomial-test" class="section level3" number="11.3.2">
<h3><span class="header-section-number">11.3.2</span> Using a binomial test</h3>
<p>The binomial test identifies genes that differ in the proportion of expressing cells between clusters.
(For the purposes of this section, a cell is considered to express a gene simply if it has non-zero expression for that gene.)
This represents a much more stringent definition of marker genes compared to the other methods, as differences in expression between clusters are effectively ignored if both distributions of expression values are not near zero.
The premise is that genes are more likely to contribute to important biological decisions if they were active in one cluster and silent in another, compared to more subtle “tuning” effects from changing the expression of an active gene.
From a practical perspective, a binary measure of presence/absence is easier to validate.</p>
<p>We perform pairwise binomial tests between clusters using the <code>findMarkers()</code> function with <code>test="binom"</code>.
This returns a list of <code>DataFrame</code>s containing marker statistics for each cluster such as the <code>Top</code> rank and its <span class="math inline">\(p\)</span>-value.
Here, the effect size is reported as the log-fold change in this proportion between each pair of clusters.
Large positive log-fold changes indicate that the gene is more frequently expressed in one cluster compared to the other.
We focus on genes that are upregulated in each cluster compared to the others by setting <code>direction="up"</code>.</p>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="marker-detection.html#cb346-1" aria-hidden="true"></a>markers.pbmc.binom &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">test=</span><span class="st">&quot;binom&quot;</span>, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb346-2"><a href="marker-detection.html#cb346-2" aria-hidden="true"></a><span class="kw">names</span>(markers.pbmc.binom)</span></code></pre></div>
<pre><code>##  [1] &quot;1&quot;  &quot;2&quot;  &quot;3&quot;  &quot;4&quot;  &quot;5&quot;  &quot;6&quot;  &quot;7&quot;  &quot;8&quot;  &quot;9&quot;  &quot;10&quot; &quot;11&quot; &quot;12&quot; &quot;13&quot; &quot;14&quot; &quot;15&quot;
## [16] &quot;16&quot;</code></pre>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="marker-detection.html#cb348-1" aria-hidden="true"></a>interesting.binom &lt;-<span class="st"> </span>markers.pbmc.binom[[chosen]]</span>
<span id="cb348-2"><a href="marker-detection.html#cb348-2" aria-hidden="true"></a><span class="kw">colnames</span>(interesting.binom)</span></code></pre></div>
<pre><code>##  [1] &quot;Top&quot;           &quot;p.value&quot;       &quot;FDR&quot;           &quot;summary.logFC&quot;
##  [5] &quot;logFC.1&quot;       &quot;logFC.2&quot;       &quot;logFC.3&quot;       &quot;logFC.4&quot;      
##  [9] &quot;logFC.5&quot;       &quot;logFC.6&quot;       &quot;logFC.8&quot;       &quot;logFC.9&quot;      
## [13] &quot;logFC.10&quot;      &quot;logFC.11&quot;      &quot;logFC.12&quot;      &quot;logFC.13&quot;     
## [17] &quot;logFC.14&quot;      &quot;logFC.15&quot;      &quot;logFC.16&quot;</code></pre>
<p>Figure <a href="marker-detection.html#fig:viol-de-binom">11.5</a> confirms that the top genes exhibit strong differences in the proportion of expressing cells in cluster 7 compared to the others.</p>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="marker-detection.html#cb350-1" aria-hidden="true"></a><span class="kw">library</span>(scater)</span>
<span id="cb350-2"><a href="marker-detection.html#cb350-2" aria-hidden="true"></a>top.genes &lt;-<span class="st"> </span><span class="kw">head</span>(<span class="kw">rownames</span>(interesting.binom))</span>
<span id="cb350-3"><a href="marker-detection.html#cb350-3" aria-hidden="true"></a><span class="kw">plotExpression</span>(sce.pbmc, <span class="dt">x=</span><span class="st">&quot;label&quot;</span>, <span class="dt">features=</span>top.genes)</span></code></pre></div>
<div class="figure"><span id="fig:viol-de-binom"></span>
<img src="marker-detection_files/figure-html/viol-de-binom-1.png" alt="Distribution of log-normalized expression values for the top 10 DE genes involving cluster 7 with the binomial test, stratified by cluster assignment and coloured by the plate of origin for each cell." width="672" />
<p class="caption">
Figure 11.5: Distribution of log-normalized expression values for the top 10 DE genes involving cluster 7 with the binomial test, stratified by cluster assignment and coloured by the plate of origin for each cell.
</p>
</div>
<p>The disadvantage of the binomial test is that its increased stringency can lead to the loss of good candidate markers.
For example, <em>GCG</em> is a known marker for pancreatic alpha cells but is expressed in almost every other cell of the <span class="citation">Lawlor et al. (<a href="#ref-lawlor2017singlecell" role="doc-biblioref">2017</a>)</span> pancreas data (Figure <a href="marker-detection.html#fig:viol-gcg-lawlor">11.6</a>) and would not be highly ranked by the binomial test.</p>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="marker-detection.html#cb351-1" aria-hidden="true"></a><span class="kw">plotExpression</span>(sce.lawlor, <span class="dt">x=</span><span class="st">&quot;cell type&quot;</span>, <span class="dt">features=</span><span class="st">&quot;ENSG00000115263&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:viol-gcg-lawlor"></span>
<img src="marker-detection_files/figure-html/viol-gcg-lawlor-1.png" alt="Distribution of log-normalized expression values for _GCG_ across different pancreatic cell types in the Lawlor pancreas data." width="672" />
<p class="caption">
Figure 11.6: Distribution of log-normalized expression values for <em>GCG</em> across different pancreatic cell types in the Lawlor pancreas data.
</p>
</div>
<p>Another property of the binomial test is that it will not respond to scaling normalization.
Systematic differences in library size between clusters will not be considered when computing <span class="math inline">\(p\)</span>-values or effect sizes.
This is not necessarily problematic for marker gene detection -
users can treat this as retaining information about the total RNA content, analogous to spike-in normalization in Section <a href="normalization.html#spike-norm">7.4</a>.</p>
</div>
<div id="using-custom-de-methods" class="section level3" number="11.3.3">
<h3><span class="header-section-number">11.3.3</span> Using custom DE methods</h3>
<p>It is also possible to perform marker gene detection based on precomputed DE statistics, which allows us to take advantage of more sophisticated tests in dedicated DE analysis packages in the Bioconductor ecosystem.
To demonstrate, consider the <code>voom()</code> approach from the <em><a href="https://bioconductor.org/packages/3.12/limma">limma</a></em> package <span class="citation">(Law et al. <a href="#ref-law2014voom" role="doc-biblioref">2014</a>)</span>.
We first process our <code>SingleCellExperiment</code> to obtain a <code>fit</code> object as shown below.</p>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="marker-detection.html#cb352-1" aria-hidden="true"></a><span class="kw">library</span>(limma)</span>
<span id="cb352-2"><a href="marker-detection.html#cb352-2" aria-hidden="true"></a>design &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span><span class="dv">0</span> <span class="op">+</span><span class="st"> </span>label, <span class="dt">data=</span><span class="kw">colData</span>(sce.pbmc))</span>
<span id="cb352-3"><a href="marker-detection.html#cb352-3" aria-hidden="true"></a><span class="kw">colnames</span>(design)</span></code></pre></div>
<pre><code>##  [1] &quot;label1&quot;  &quot;label2&quot;  &quot;label3&quot;  &quot;label4&quot;  &quot;label5&quot;  &quot;label6&quot;  &quot;label7&quot; 
##  [8] &quot;label8&quot;  &quot;label9&quot;  &quot;label10&quot; &quot;label11&quot; &quot;label12&quot; &quot;label13&quot; &quot;label14&quot;
## [15] &quot;label15&quot; &quot;label16&quot;</code></pre>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="marker-detection.html#cb354-1" aria-hidden="true"></a><span class="co"># Removing very low-abundance genes.</span></span>
<span id="cb354-2"><a href="marker-detection.html#cb354-2" aria-hidden="true"></a>keep &lt;-<span class="st"> </span><span class="kw">calculateAverage</span>(sce.pbmc) <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.1</span> </span>
<span id="cb354-3"><a href="marker-detection.html#cb354-3" aria-hidden="true"></a><span class="kw">summary</span>(keep)</span></code></pre></div>
<pre><code>##    Mode   FALSE    TRUE 
## logical   29465    4229</code></pre>
<div class="sourceCode" id="cb356"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb356-1"><a href="marker-detection.html#cb356-1" aria-hidden="true"></a>y &lt;-<span class="st"> </span><span class="kw">convertTo</span>(sce.pbmc, <span class="dt">subset.row=</span>keep)</span>
<span id="cb356-2"><a href="marker-detection.html#cb356-2" aria-hidden="true"></a>v &lt;-<span class="st"> </span><span class="kw">voom</span>(y, design)</span>
<span id="cb356-3"><a href="marker-detection.html#cb356-3" aria-hidden="true"></a>fit &lt;-<span class="st"> </span><span class="kw">lmFit</span>(v, design)</span></code></pre></div>
<p>We then perform pairwise comparisons between clusters using the TREAT strategy <span class="citation">(McCarthy and Smyth <a href="#ref-mccarthy2009treat" role="doc-biblioref">2009</a>)</span> to test for log-fold changes that are significantly greater than 0.5.
For each comparison, we store the corresponding data frame of statistics in <code>all.results</code>, along with the identities of the clusters involved in <code>all.pairs</code>.</p>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="marker-detection.html#cb357-1" aria-hidden="true"></a>nclust &lt;-<span class="st"> </span><span class="kw">length</span>(<span class="kw">unique</span>(<span class="kw">colLabels</span>(sce.pbmc)))</span>
<span id="cb357-2"><a href="marker-detection.html#cb357-2" aria-hidden="true"></a>all.results &lt;-<span class="st"> </span>all.pairs &lt;-<span class="st"> </span><span class="kw">list</span>()</span>
<span id="cb357-3"><a href="marker-detection.html#cb357-3" aria-hidden="true"></a>counter &lt;-<span class="st"> </span>1L</span>
<span id="cb357-4"><a href="marker-detection.html#cb357-4" aria-hidden="true"></a></span>
<span id="cb357-5"><a href="marker-detection.html#cb357-5" aria-hidden="true"></a><span class="co"># Iterating across the first &#39;nclust&#39; coefficients in design,</span></span>
<span id="cb357-6"><a href="marker-detection.html#cb357-6" aria-hidden="true"></a><span class="co"># and comparing them to each other in a pairwise manner.</span></span>
<span id="cb357-7"><a href="marker-detection.html#cb357-7" aria-hidden="true"></a><span class="cf">for</span> (x <span class="cf">in</span> <span class="kw">seq_len</span>(nclust)) {</span>
<span id="cb357-8"><a href="marker-detection.html#cb357-8" aria-hidden="true"></a>    <span class="cf">for</span> (y <span class="cf">in</span> <span class="kw">seq_len</span>(x<span class="op">-</span>1L)) {</span>
<span id="cb357-9"><a href="marker-detection.html#cb357-9" aria-hidden="true"></a>        con &lt;-<span class="st"> </span><span class="kw">integer</span>(<span class="kw">ncol</span>(design))</span>
<span id="cb357-10"><a href="marker-detection.html#cb357-10" aria-hidden="true"></a>        con[x] &lt;-<span class="st"> </span><span class="dv">1</span></span>
<span id="cb357-11"><a href="marker-detection.html#cb357-11" aria-hidden="true"></a>        con[y] &lt;-<span class="st"> </span><span class="dv">-1</span></span>
<span id="cb357-12"><a href="marker-detection.html#cb357-12" aria-hidden="true"></a>        fit2 &lt;-<span class="st"> </span><span class="kw">contrasts.fit</span>(fit, con)</span>
<span id="cb357-13"><a href="marker-detection.html#cb357-13" aria-hidden="true"></a>        fit2 &lt;-<span class="st"> </span><span class="kw">treat</span>(fit2, <span class="dt">robust=</span><span class="ot">TRUE</span>, <span class="dt">lfc=</span><span class="fl">0.5</span>)</span>
<span id="cb357-14"><a href="marker-detection.html#cb357-14" aria-hidden="true"></a></span>
<span id="cb357-15"><a href="marker-detection.html#cb357-15" aria-hidden="true"></a>        res &lt;-<span class="st"> </span><span class="kw">topTreat</span>(fit2, <span class="dt">n=</span><span class="ot">Inf</span>, <span class="dt">sort.by=</span><span class="st">&quot;none&quot;</span>)</span>
<span id="cb357-16"><a href="marker-detection.html#cb357-16" aria-hidden="true"></a>        all.results[[counter]] &lt;-<span class="st"> </span>res</span>
<span id="cb357-17"><a href="marker-detection.html#cb357-17" aria-hidden="true"></a>        all.pairs[[counter]] &lt;-<span class="st"> </span><span class="kw">colnames</span>(design)[<span class="kw">c</span>(x, y)]</span>
<span id="cb357-18"><a href="marker-detection.html#cb357-18" aria-hidden="true"></a>        counter &lt;-<span class="st"> </span>counter<span class="op">+</span>1L</span>
<span id="cb357-19"><a href="marker-detection.html#cb357-19" aria-hidden="true"></a></span>
<span id="cb357-20"><a href="marker-detection.html#cb357-20" aria-hidden="true"></a>        <span class="co"># Also filling the reverse comparison.</span></span>
<span id="cb357-21"><a href="marker-detection.html#cb357-21" aria-hidden="true"></a>        res<span class="op">$</span>logFC &lt;-<span class="st"> </span><span class="op">-</span>res<span class="op">$</span>logFC</span>
<span id="cb357-22"><a href="marker-detection.html#cb357-22" aria-hidden="true"></a>        all.results[[counter]] &lt;-<span class="st"> </span>res</span>
<span id="cb357-23"><a href="marker-detection.html#cb357-23" aria-hidden="true"></a>        all.pairs[[counter]] &lt;-<span class="st"> </span><span class="kw">colnames</span>(design)[<span class="kw">c</span>(y, x)]</span>
<span id="cb357-24"><a href="marker-detection.html#cb357-24" aria-hidden="true"></a>        counter &lt;-<span class="st"> </span>counter<span class="op">+</span>1L</span>
<span id="cb357-25"><a href="marker-detection.html#cb357-25" aria-hidden="true"></a>    }</span>
<span id="cb357-26"><a href="marker-detection.html#cb357-26" aria-hidden="true"></a>}</span></code></pre></div>
<p>These custom results are consolidated into a single marker list for each cluster with the <code>combineMarkers()</code> function.
This combines test statistics across all pairwise comparisons involving a single cluster,
yielding a per-cluster <code>DataFrame</code> that can be interpreted in the same manner as discussed previously.</p>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="marker-detection.html#cb358-1" aria-hidden="true"></a>all.pairs &lt;-<span class="st"> </span><span class="kw">do.call</span>(rbind, all.pairs)</span>
<span id="cb358-2"><a href="marker-detection.html#cb358-2" aria-hidden="true"></a>combined &lt;-<span class="st"> </span><span class="kw">combineMarkers</span>(all.results, all.pairs, <span class="dt">pval.field=</span><span class="st">&quot;P.Value&quot;</span>)</span>
<span id="cb358-3"><a href="marker-detection.html#cb358-3" aria-hidden="true"></a></span>
<span id="cb358-4"><a href="marker-detection.html#cb358-4" aria-hidden="true"></a><span class="co"># Inspecting results for our cluster of interest again.</span></span>
<span id="cb358-5"><a href="marker-detection.html#cb358-5" aria-hidden="true"></a>interesting.voom &lt;-<span class="st"> </span>combined[[<span class="kw">paste0</span>(<span class="st">&quot;cluster&quot;</span>, chosen)]] </span>
<span id="cb358-6"><a href="marker-detection.html#cb358-6" aria-hidden="true"></a><span class="kw">colnames</span>(interesting.voom)</span></code></pre></div>
<pre><code>## NULL</code></pre>
<div class="sourceCode" id="cb360"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb360-1"><a href="marker-detection.html#cb360-1" aria-hidden="true"></a><span class="kw">head</span>(interesting.voom[,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>])</span></code></pre></div>
<pre><code>## NULL</code></pre>
<p>By default, we do not use custom DE methods to perform marker detection, for several reasons.
Many of these methods rely on empirical Bayes shrinkage to share information across genes in the presence of limited replication.
However, this is unnecessary when there are large numbers of “replicate” cells in each group (Section <a href="marker-detection.html#false-replicates">11.5.2</a>).
These methods also make stronger assumptions about the data (e.g., equal variances for linear models, the distribution of variances during empirical Bayes) that are more likely to be violated in noisy scRNA-seq contexts.
From a practical perspective, they require more work to set up and take more time to run.
Nonetheless, some custom methods (e.g., <em><a href="https://bioconductor.org/packages/3.12/MAST">MAST</a></em>) may provide a useful point of difference from the simpler tests, in which case they can be converted into a marker detection scheme as described above.</p>
</div>
<div id="combining-multiple-marker-statistics" class="section level3" number="11.3.4">
<h3><span class="header-section-number">11.3.4</span> Combining multiple marker statistics</h3>
<p>On occasion, we might want to combine marker statistics from several testing regimes into a single <code>DataFrame</code>.
This allows us to easily inspect multiple statistics at once to verify that a particular gene is a strong candidate marker.
For example, a large AUC from the WMW test indicates that the expression distributions are well-separated between clusters, while the log-fold change reported with the <span class="math inline">\(t\)</span>-test provides a more interpretable measure of the magnitude of the change in expression.
We use the <code>multiMarkerStats()</code> to merge the results of separate <code>findMarkers()</code> calls into one <code>DataFrame</code> per cluster, with statistics interleaved to facilitate a direct comparison between different test regimes.</p>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="marker-detection.html#cb362-1" aria-hidden="true"></a>combined &lt;-<span class="st"> </span><span class="kw">multiMarkerStats</span>(</span>
<span id="cb362-2"><a href="marker-detection.html#cb362-2" aria-hidden="true"></a>    <span class="dt">t=</span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>),</span>
<span id="cb362-3"><a href="marker-detection.html#cb362-3" aria-hidden="true"></a>    <span class="dt">wilcox=</span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">test=</span><span class="st">&quot;wilcox&quot;</span>, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>),</span>
<span id="cb362-4"><a href="marker-detection.html#cb362-4" aria-hidden="true"></a>    <span class="dt">binom=</span><span class="kw">findMarkers</span>(sce.pbmc, <span class="dt">test=</span><span class="st">&quot;binom&quot;</span>, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb362-5"><a href="marker-detection.html#cb362-5" aria-hidden="true"></a>)</span>
<span id="cb362-6"><a href="marker-detection.html#cb362-6" aria-hidden="true"></a></span>
<span id="cb362-7"><a href="marker-detection.html#cb362-7" aria-hidden="true"></a><span class="co"># Interleaved marker statistics from both tests for each cluster.</span></span>
<span id="cb362-8"><a href="marker-detection.html#cb362-8" aria-hidden="true"></a><span class="kw">colnames</span>(combined[[<span class="st">&quot;1&quot;</span>]])</span></code></pre></div>
<pre><code>##  [1] &quot;Top&quot;                 &quot;p.value&quot;             &quot;FDR&quot;                
##  [4] &quot;t.Top&quot;               &quot;wilcox.Top&quot;          &quot;binom.Top&quot;          
##  [7] &quot;t.p.value&quot;           &quot;wilcox.p.value&quot;      &quot;binom.p.value&quot;      
## [10] &quot;t.FDR&quot;               &quot;wilcox.FDR&quot;          &quot;binom.FDR&quot;          
## [13] &quot;t.summary.logFC&quot;     &quot;wilcox.summary.AUC&quot;  &quot;binom.summary.logFC&quot;
## [16] &quot;t.logFC.2&quot;           &quot;wilcox.AUC.2&quot;        &quot;binom.logFC.2&quot;      
## [19] &quot;t.logFC.3&quot;           &quot;wilcox.AUC.3&quot;        &quot;binom.logFC.3&quot;      
## [22] &quot;t.logFC.4&quot;           &quot;wilcox.AUC.4&quot;        &quot;binom.logFC.4&quot;      
## [25] &quot;t.logFC.5&quot;           &quot;wilcox.AUC.5&quot;        &quot;binom.logFC.5&quot;      
## [28] &quot;t.logFC.6&quot;           &quot;wilcox.AUC.6&quot;        &quot;binom.logFC.6&quot;      
## [31] &quot;t.logFC.7&quot;           &quot;wilcox.AUC.7&quot;        &quot;binom.logFC.7&quot;      
## [34] &quot;t.logFC.8&quot;           &quot;wilcox.AUC.8&quot;        &quot;binom.logFC.8&quot;      
## [37] &quot;t.logFC.9&quot;           &quot;wilcox.AUC.9&quot;        &quot;binom.logFC.9&quot;      
## [40] &quot;t.logFC.10&quot;          &quot;wilcox.AUC.10&quot;       &quot;binom.logFC.10&quot;     
## [43] &quot;t.logFC.11&quot;          &quot;wilcox.AUC.11&quot;       &quot;binom.logFC.11&quot;     
## [46] &quot;t.logFC.12&quot;          &quot;wilcox.AUC.12&quot;       &quot;binom.logFC.12&quot;     
## [49] &quot;t.logFC.13&quot;          &quot;wilcox.AUC.13&quot;       &quot;binom.logFC.13&quot;     
## [52] &quot;t.logFC.14&quot;          &quot;wilcox.AUC.14&quot;       &quot;binom.logFC.14&quot;     
## [55] &quot;t.logFC.15&quot;          &quot;wilcox.AUC.15&quot;       &quot;binom.logFC.15&quot;     
## [58] &quot;t.logFC.16&quot;          &quot;wilcox.AUC.16&quot;       &quot;binom.logFC.16&quot;</code></pre>
<div class="sourceCode" id="cb364"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb364-1"><a href="marker-detection.html#cb364-1" aria-hidden="true"></a><span class="kw">head</span>(combined[[<span class="st">&quot;1&quot;</span>]][,<span class="dv">1</span><span class="op">:</span><span class="dv">9</span>])</span></code></pre></div>
<pre><code>## DataFrame with 6 rows and 9 columns
##              Top     p.value         FDR     t.Top wilcox.Top binom.Top
##        &lt;integer&gt;   &lt;numeric&gt;   &lt;numeric&gt; &lt;integer&gt;  &lt;integer&gt; &lt;integer&gt;
## TYROBP         1 1.36219e-37 1.31136e-34         1          1         1
## FCER1G         2 5.54939e-48 8.90386e-45         1          1         2
## GZMA           2 7.10783e-83 2.39491e-78         1          2         1
## HOPX           2 1.25041e-79 2.10656e-75         2          1         1
## CTSW           3 2.51098e-71 1.20864e-67         1          1         3
## KLRF1          3 5.69193e-66 2.39730e-62         3          1         1
##           t.p.value wilcox.p.value binom.p.value
##           &lt;numeric&gt;      &lt;numeric&gt;     &lt;numeric&gt;
## TYROBP 3.93768e-112   2.99215e-124   1.36219e-37
## FCER1G  4.67496e-82   1.73332e-116   5.54939e-48
## GZMA    1.06381e-88   1.00829e-165   7.10783e-83
## HOPX    1.25041e-79   3.23816e-190  2.40034e-111
## CTSW   1.13373e-107   7.90522e-131   2.51098e-71
## KLRF1   5.69193e-66   2.73030e-184  2.77818e-113</code></pre>
<p>In addition, <code>multiMarkerStats()</code> will compute a number of new statistics by combining the per-regime statistics.
The combined <code>Top</code> value is obtained by simply taking the largest <code>Top</code> value across all tests for a given gene, while the reported <code>p.value</code> is obtained by taking the largest <span class="math inline">\(p\)</span>-value.
Ranking on either metric focuses on genes with robust differences that are highly ranked and detected by each of the individual testing regimes.
Of course, this might be considered an overly conservative approach in practice, so it is entirely permissible to re-rank the <code>DataFrame</code> according to the <code>Top</code> or <code>p.value</code> for an individual regime (effectively limiting the use of the other regimes’ statistics to diagnostics only).</p>
</div>
</div>
<div id="marker-batch" class="section level2" number="11.4">
<h2><span class="header-section-number">11.4</span> Handling blocking factors</h2>
<div id="using-the-block-argument" class="section level3" number="11.4.1">
<h3><span class="header-section-number">11.4.1</span> Using the <code>block=</code> argument</h3>
<p>Large studies may contain factors of variation that are known and not interesting (e.g., batch effects, sex differences).
If these are not modelled, they can interfere with marker gene detection - most obviously by inflating the variance within each cluster, but also by distorting the log-fold changes if the cluster composition varies across levels of the blocking factor.
To avoid these issues, we set the <code>block=</code> argument in the <code>findMarkers()</code> call, as demonstrated below for the 416B data set.</p>
<button class="rebook-collapse">
View history
</button>
<div class="rebook-content">
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="marker-detection.html#cb366-1" aria-hidden="true"></a><span class="co">#--- loading ---#</span></span>
<span id="cb366-2"><a href="marker-detection.html#cb366-2" aria-hidden="true"></a><span class="kw">library</span>(scRNAseq)</span>
<span id="cb366-3"><a href="marker-detection.html#cb366-3" aria-hidden="true"></a>sce<span class="fl">.416</span>b &lt;-<span class="st"> </span><span class="kw">LunSpikeInData</span>(<span class="dt">which=</span><span class="st">&quot;416b&quot;</span>) </span>
<span id="cb366-4"><a href="marker-detection.html#cb366-4" aria-hidden="true"></a>sce<span class="fl">.416</span>b<span class="op">$</span>block &lt;-<span class="st"> </span><span class="kw">factor</span>(sce<span class="fl">.416</span>b<span class="op">$</span>block)</span>
<span id="cb366-5"><a href="marker-detection.html#cb366-5" aria-hidden="true"></a></span>
<span id="cb366-6"><a href="marker-detection.html#cb366-6" aria-hidden="true"></a><span class="co">#--- gene-annotation ---#</span></span>
<span id="cb366-7"><a href="marker-detection.html#cb366-7" aria-hidden="true"></a><span class="kw">library</span>(AnnotationHub)</span>
<span id="cb366-8"><a href="marker-detection.html#cb366-8" aria-hidden="true"></a>ens.mm.v97 &lt;-<span class="st"> </span><span class="kw">AnnotationHub</span>()[[<span class="st">&quot;AH73905&quot;</span>]]</span>
<span id="cb366-9"><a href="marker-detection.html#cb366-9" aria-hidden="true"></a><span class="kw">rowData</span>(sce<span class="fl">.416</span>b)<span class="op">$</span>ENSEMBL &lt;-<span class="st"> </span><span class="kw">rownames</span>(sce<span class="fl">.416</span>b)</span>
<span id="cb366-10"><a href="marker-detection.html#cb366-10" aria-hidden="true"></a><span class="kw">rowData</span>(sce<span class="fl">.416</span>b)<span class="op">$</span>SYMBOL &lt;-<span class="st"> </span><span class="kw">mapIds</span>(ens.mm.v97, <span class="dt">keys=</span><span class="kw">rownames</span>(sce<span class="fl">.416</span>b),</span>
<span id="cb366-11"><a href="marker-detection.html#cb366-11" aria-hidden="true"></a>    <span class="dt">keytype=</span><span class="st">&quot;GENEID&quot;</span>, <span class="dt">column=</span><span class="st">&quot;SYMBOL&quot;</span>)</span>
<span id="cb366-12"><a href="marker-detection.html#cb366-12" aria-hidden="true"></a><span class="kw">rowData</span>(sce<span class="fl">.416</span>b)<span class="op">$</span>SEQNAME &lt;-<span class="st"> </span><span class="kw">mapIds</span>(ens.mm.v97, <span class="dt">keys=</span><span class="kw">rownames</span>(sce<span class="fl">.416</span>b),</span>
<span id="cb366-13"><a href="marker-detection.html#cb366-13" aria-hidden="true"></a>    <span class="dt">keytype=</span><span class="st">&quot;GENEID&quot;</span>, <span class="dt">column=</span><span class="st">&quot;SEQNAME&quot;</span>)</span>
<span id="cb366-14"><a href="marker-detection.html#cb366-14" aria-hidden="true"></a></span>
<span id="cb366-15"><a href="marker-detection.html#cb366-15" aria-hidden="true"></a><span class="kw">library</span>(scater)</span>
<span id="cb366-16"><a href="marker-detection.html#cb366-16" aria-hidden="true"></a><span class="kw">rownames</span>(sce<span class="fl">.416</span>b) &lt;-<span class="st"> </span><span class="kw">uniquifyFeatureNames</span>(<span class="kw">rowData</span>(sce<span class="fl">.416</span>b)<span class="op">$</span>ENSEMBL, </span>
<span id="cb366-17"><a href="marker-detection.html#cb366-17" aria-hidden="true"></a>    <span class="kw">rowData</span>(sce<span class="fl">.416</span>b)<span class="op">$</span>SYMBOL)</span>
<span id="cb366-18"><a href="marker-detection.html#cb366-18" aria-hidden="true"></a></span>
<span id="cb366-19"><a href="marker-detection.html#cb366-19" aria-hidden="true"></a><span class="co">#--- quality-control ---#</span></span>
<span id="cb366-20"><a href="marker-detection.html#cb366-20" aria-hidden="true"></a>mito &lt;-<span class="st"> </span><span class="kw">which</span>(<span class="kw">rowData</span>(sce<span class="fl">.416</span>b)<span class="op">$</span>SEQNAME<span class="op">==</span><span class="st">&quot;MT&quot;</span>)</span>
<span id="cb366-21"><a href="marker-detection.html#cb366-21" aria-hidden="true"></a>stats &lt;-<span class="st"> </span><span class="kw">perCellQCMetrics</span>(sce<span class="fl">.416</span>b, <span class="dt">subsets=</span><span class="kw">list</span>(<span class="dt">Mt=</span>mito))</span>
<span id="cb366-22"><a href="marker-detection.html#cb366-22" aria-hidden="true"></a>qc &lt;-<span class="st"> </span><span class="kw">quickPerCellQC</span>(stats, <span class="dt">percent_subsets=</span><span class="kw">c</span>(<span class="st">&quot;subsets_Mt_percent&quot;</span>,</span>
<span id="cb366-23"><a href="marker-detection.html#cb366-23" aria-hidden="true"></a>    <span class="st">&quot;altexps_ERCC_percent&quot;</span>), <span class="dt">batch=</span>sce<span class="fl">.416</span>b<span class="op">$</span>block)</span>
<span id="cb366-24"><a href="marker-detection.html#cb366-24" aria-hidden="true"></a>sce<span class="fl">.416</span>b &lt;-<span class="st"> </span>sce<span class="fl">.416</span>b[,<span class="op">!</span>qc<span class="op">$</span>discard]</span>
<span id="cb366-25"><a href="marker-detection.html#cb366-25" aria-hidden="true"></a></span>
<span id="cb366-26"><a href="marker-detection.html#cb366-26" aria-hidden="true"></a><span class="co">#--- normalization ---#</span></span>
<span id="cb366-27"><a href="marker-detection.html#cb366-27" aria-hidden="true"></a><span class="kw">library</span>(scran)</span>
<span id="cb366-28"><a href="marker-detection.html#cb366-28" aria-hidden="true"></a>sce<span class="fl">.416</span>b &lt;-<span class="st"> </span><span class="kw">computeSumFactors</span>(sce<span class="fl">.416</span>b)</span>
<span id="cb366-29"><a href="marker-detection.html#cb366-29" aria-hidden="true"></a>sce<span class="fl">.416</span>b &lt;-<span class="st"> </span><span class="kw">logNormCounts</span>(sce<span class="fl">.416</span>b)</span>
<span id="cb366-30"><a href="marker-detection.html#cb366-30" aria-hidden="true"></a></span>
<span id="cb366-31"><a href="marker-detection.html#cb366-31" aria-hidden="true"></a><span class="co">#--- variance-modelling ---#</span></span>
<span id="cb366-32"><a href="marker-detection.html#cb366-32" aria-hidden="true"></a>dec<span class="fl">.416</span>b &lt;-<span class="st"> </span><span class="kw">modelGeneVarWithSpikes</span>(sce<span class="fl">.416</span>b, <span class="st">&quot;ERCC&quot;</span>, <span class="dt">block=</span>sce<span class="fl">.416</span>b<span class="op">$</span>block)</span>
<span id="cb366-33"><a href="marker-detection.html#cb366-33" aria-hidden="true"></a>chosen.hvgs &lt;-<span class="st"> </span><span class="kw">getTopHVGs</span>(dec<span class="fl">.416</span>b, <span class="dt">prop=</span><span class="fl">0.1</span>)</span>
<span id="cb366-34"><a href="marker-detection.html#cb366-34" aria-hidden="true"></a></span>
<span id="cb366-35"><a href="marker-detection.html#cb366-35" aria-hidden="true"></a><span class="co">#--- batch-correction ---#</span></span>
<span id="cb366-36"><a href="marker-detection.html#cb366-36" aria-hidden="true"></a><span class="kw">library</span>(limma)</span>
<span id="cb366-37"><a href="marker-detection.html#cb366-37" aria-hidden="true"></a><span class="kw">assay</span>(sce<span class="fl">.416</span>b, <span class="st">&quot;corrected&quot;</span>) &lt;-<span class="st"> </span><span class="kw">removeBatchEffect</span>(<span class="kw">logcounts</span>(sce<span class="fl">.416</span>b), </span>
<span id="cb366-38"><a href="marker-detection.html#cb366-38" aria-hidden="true"></a>    <span class="dt">design=</span><span class="kw">model.matrix</span>(<span class="op">~</span>sce<span class="fl">.416</span>b<span class="op">$</span>phenotype), <span class="dt">batch=</span>sce<span class="fl">.416</span>b<span class="op">$</span>block)</span>
<span id="cb366-39"><a href="marker-detection.html#cb366-39" aria-hidden="true"></a></span>
<span id="cb366-40"><a href="marker-detection.html#cb366-40" aria-hidden="true"></a><span class="co">#--- dimensionality-reduction ---#</span></span>
<span id="cb366-41"><a href="marker-detection.html#cb366-41" aria-hidden="true"></a>sce<span class="fl">.416</span>b &lt;-<span class="st"> </span><span class="kw">runPCA</span>(sce<span class="fl">.416</span>b, <span class="dt">ncomponents=</span><span class="dv">10</span>, <span class="dt">subset_row=</span>chosen.hvgs,</span>
<span id="cb366-42"><a href="marker-detection.html#cb366-42" aria-hidden="true"></a>    <span class="dt">exprs_values=</span><span class="st">&quot;corrected&quot;</span>, <span class="dt">BSPARAM=</span>BiocSingular<span class="op">::</span><span class="kw">ExactParam</span>())</span>
<span id="cb366-43"><a href="marker-detection.html#cb366-43" aria-hidden="true"></a></span>
<span id="cb366-44"><a href="marker-detection.html#cb366-44" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">1010</span>)</span>
<span id="cb366-45"><a href="marker-detection.html#cb366-45" aria-hidden="true"></a>sce<span class="fl">.416</span>b &lt;-<span class="st"> </span><span class="kw">runTSNE</span>(sce<span class="fl">.416</span>b, <span class="dt">dimred=</span><span class="st">&quot;PCA&quot;</span>, <span class="dt">perplexity=</span><span class="dv">10</span>)</span>
<span id="cb366-46"><a href="marker-detection.html#cb366-46" aria-hidden="true"></a></span>
<span id="cb366-47"><a href="marker-detection.html#cb366-47" aria-hidden="true"></a><span class="co">#--- clustering ---#</span></span>
<span id="cb366-48"><a href="marker-detection.html#cb366-48" aria-hidden="true"></a>my.dist &lt;-<span class="st"> </span><span class="kw">dist</span>(<span class="kw">reducedDim</span>(sce<span class="fl">.416</span>b, <span class="st">&quot;PCA&quot;</span>))</span>
<span id="cb366-49"><a href="marker-detection.html#cb366-49" aria-hidden="true"></a>my.tree &lt;-<span class="st"> </span><span class="kw">hclust</span>(my.dist, <span class="dt">method=</span><span class="st">&quot;ward.D2&quot;</span>)</span>
<span id="cb366-50"><a href="marker-detection.html#cb366-50" aria-hidden="true"></a></span>
<span id="cb366-51"><a href="marker-detection.html#cb366-51" aria-hidden="true"></a><span class="kw">library</span>(dynamicTreeCut)</span>
<span id="cb366-52"><a href="marker-detection.html#cb366-52" aria-hidden="true"></a>my.clusters &lt;-<span class="st"> </span><span class="kw">unname</span>(<span class="kw">cutreeDynamic</span>(my.tree, <span class="dt">distM=</span><span class="kw">as.matrix</span>(my.dist),</span>
<span id="cb366-53"><a href="marker-detection.html#cb366-53" aria-hidden="true"></a>    <span class="dt">minClusterSize=</span><span class="dv">10</span>, <span class="dt">verbose=</span><span class="dv">0</span>))</span>
<span id="cb366-54"><a href="marker-detection.html#cb366-54" aria-hidden="true"></a><span class="kw">colLabels</span>(sce<span class="fl">.416</span>b) &lt;-<span class="st"> </span><span class="kw">factor</span>(my.clusters)</span></code></pre></div>
</div>
<div class="sourceCode" id="cb367"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb367-1"><a href="marker-detection.html#cb367-1" aria-hidden="true"></a>m.out &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce<span class="fl">.416</span>b, <span class="dt">block=</span>sce<span class="fl">.416</span>b<span class="op">$</span>block, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>) </span></code></pre></div>
<p>For each gene, each pairwise comparison between clusters is performed separately in each level of the blocking factor - in this case, the plate of origin.
The function will then combine <span class="math inline">\(p\)</span>-values from different plates using Stouffer’s Z method to obtain a single <span class="math inline">\(p\)</span>-value per pairwise comparison.
(These <span class="math inline">\(p\)</span>-values are further combined across comparisons to obtain a single <span class="math inline">\(p\)</span>-value per gene, using either Simes’ method or an intersection-union test depending on the value of <code>pval.type=</code>.)
This approach favours genes that exhibit consistent DE in the same direction in each plate.</p>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="marker-detection.html#cb368-1" aria-hidden="true"></a>demo &lt;-<span class="st"> </span>m.out[[<span class="st">&quot;1&quot;</span>]] </span>
<span id="cb368-2"><a href="marker-detection.html#cb368-2" aria-hidden="true"></a>demo[demo<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## DataFrame with 13 rows and 4 columns
##                          Top     p.value         FDR summary.logFC
##                    &lt;integer&gt;   &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## Foxs1                      1 1.37387e-12 4.35563e-10       3.07058
## Pirb                       1 2.08277e-33 1.21332e-29       5.87820
## Myh11                      1 6.44327e-47 3.00282e-42       4.38182
## Tmsb4x                     2 3.22944e-44 7.52525e-40       1.47689
## Ctsd                       2 6.78109e-38 7.90065e-34       2.89152
## ...                      ...         ...         ...           ...
## Tob1                       4 6.63870e-09 1.18088e-06       2.74161
## Pi16                       4 1.69247e-32 7.88758e-29       5.76914
## Cd53                       5 1.08574e-27 2.97646e-24       5.75200
## Alox5ap                    5 1.33791e-28 4.15679e-25       1.36676
## CBFB-MYH11-mcherry         5 3.75556e-35 3.50049e-31       3.01677</code></pre>
<p>The <code>block=</code> argument works with all tests shown above and is robust to difference in the log-fold changes or variance between batches.
However, it assumes that each pair of clusters is present in at least one batch.
In scenarios where cells from two clusters never co-occur in the same batch, the comparison will be impossible and <code>NA</code>s will be reported in the output.</p>
</div>
<div id="using-the-design-argument" class="section level3" number="11.4.2">
<h3><span class="header-section-number">11.4.2</span> Using the <code>design=</code> argument</h3>
<p>Another approach is to define a design matrix containing the batch of origin as the sole factor.
<code>findMarkers()</code> will then fit a linear model to the log-expression values, similar to the use of <em><a href="https://bioconductor.org/packages/3.12/limma">limma</a></em> for bulk RNA sequencing data <span class="citation">(Ritchie et al. <a href="#ref-ritchie2015limma" role="doc-biblioref">2015</a>)</span>.
This handles situations where multiple batches contain unique clusters, as comparisons can be implicitly performed via shared cell types in each batch.
There is also a slight increase in power when information is shared across clusters for variance estimation.</p>
<div class="sourceCode" id="cb370"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb370-1"><a href="marker-detection.html#cb370-1" aria-hidden="true"></a><span class="co"># Setting up the design matrix (we remove intercept for full rank</span></span>
<span id="cb370-2"><a href="marker-detection.html#cb370-2" aria-hidden="true"></a><span class="co"># in the final design matrix with the cluster-specific terms).</span></span>
<span id="cb370-3"><a href="marker-detection.html#cb370-3" aria-hidden="true"></a>design &lt;-<span class="st"> </span><span class="kw">model.matrix</span>(<span class="op">~</span>sce<span class="fl">.416</span>b<span class="op">$</span>block)</span>
<span id="cb370-4"><a href="marker-detection.html#cb370-4" aria-hidden="true"></a>design &lt;-<span class="st"> </span>design[,<span class="op">-</span><span class="dv">1</span>,drop=<span class="ot">FALSE</span>]</span>
<span id="cb370-5"><a href="marker-detection.html#cb370-5" aria-hidden="true"></a></span>
<span id="cb370-6"><a href="marker-detection.html#cb370-6" aria-hidden="true"></a>m.alt &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(sce<span class="fl">.416</span>b, <span class="dt">design=</span>design, <span class="dt">direction=</span><span class="st">&quot;up&quot;</span>)</span>
<span id="cb370-7"><a href="marker-detection.html#cb370-7" aria-hidden="true"></a>demo &lt;-<span class="st"> </span>m.alt[[<span class="st">&quot;1&quot;</span>]]</span>
<span id="cb370-8"><a href="marker-detection.html#cb370-8" aria-hidden="true"></a>demo[demo<span class="op">$</span>Top <span class="op">&lt;=</span><span class="st"> </span><span class="dv">5</span>,<span class="dv">1</span><span class="op">:</span><span class="dv">4</span>]</span></code></pre></div>
<pre><code>## DataFrame with 12 rows and 4 columns
##                          Top     p.value         FDR summary.logFC
##                    &lt;integer&gt;   &lt;numeric&gt;   &lt;numeric&gt;     &lt;numeric&gt;
## Gm6977                     1 7.15187e-24 8.77120e-21      0.810553
## Myh11                      1 4.56882e-64 2.12925e-59      4.381806
## Tmsb4x                     2 9.48997e-46 2.21135e-41      1.478213
## Cd63                       2 1.80446e-15 7.85933e-13      0.813016
## Cd200r3                    2 2.40861e-45 3.74170e-41      6.684003
## ...                      ...         ...         ...           ...
## Actb                       4 5.61751e-36 2.90887e-32      0.961762
## Ctsd                       4 2.08646e-42 2.43094e-38      2.893014
## Fth1                       4 1.83949e-23 2.14319e-20      0.797407
## Ccl9                       5 1.75378e-30 3.71514e-27      5.396347
## CBFB-MYH11-mcherry         5 9.09026e-39 8.47285e-35      3.017758</code></pre>
<p>The use of a linear model makes some strong assumptions, necessitating some caution when interpreting the results.
If the batch effect is not consistent across clusters, the variance will be inflated and the log-fold change estimates will be distorted.
Variances are also assumed to be equal across groups, which is not true in general.
In particular, the presence of clusters in which a gene is silent will shrink the residual variance towards zero, preventing the model from penalizing genes with high variance in other clusters.
Thus, we generally recommend the use of <code>block=</code> where possible.</p>
</div>
</div>
<div id="p-value-invalidity" class="section level2" number="11.5">
<h2><span class="header-section-number">11.5</span> Invalidity of <span class="math inline">\(p\)</span>-values</h2>
<div id="from-data-snooping" class="section level3" number="11.5.1">
<h3><span class="header-section-number">11.5.1</span> From data snooping</h3>
<p>All of our DE strategies for detecting marker genes between clusters are statistically flawed to some extent.
The DE analysis is performed on the same data used to obtain the clusters, which represents “data dredging” (also known as fishing or data snooping).
The hypothesis of interest - are there differences between clusters? - is formulated from the data, so we are more likely to get a positive result when we re-use the data set to test that hypothesis.</p>
<p>The practical effect of data dredging is best illustrated with a simple simulation.
We simulate i.i.d. normal values, perform <span class="math inline">\(k\)</span>-means clustering and test for DE between clusters of cells with <code>findMarkers()</code>.
The resulting distribution of <span class="math inline">\(p\)</span>-values is heavily skewed towards low values (Figure <a href="marker-detection.html#fig:pval-dist">11.7</a>).
Thus, we can detect “significant” differences between clusters even in the absence of any real substructure in the data.
This effect arises from the fact that clustering, by definition, yields groups of cells that are separated in expression space.
Testing for DE genes between clusters will inevitably yield some significant results as that is how the clusters were defined.</p>
<div class="sourceCode" id="cb372"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb372-1"><a href="marker-detection.html#cb372-1" aria-hidden="true"></a><span class="kw">library</span>(scran)</span>
<span id="cb372-2"><a href="marker-detection.html#cb372-2" aria-hidden="true"></a><span class="kw">set.seed</span>(<span class="dv">0</span>)</span>
<span id="cb372-3"><a href="marker-detection.html#cb372-3" aria-hidden="true"></a>y &lt;-<span class="st"> </span><span class="kw">matrix</span>(<span class="kw">rnorm</span>(<span class="dv">100000</span>), <span class="dt">ncol=</span><span class="dv">200</span>)</span>
<span id="cb372-4"><a href="marker-detection.html#cb372-4" aria-hidden="true"></a>clusters &lt;-<span class="st"> </span><span class="kw">kmeans</span>(<span class="kw">t</span>(y), <span class="dt">centers=</span><span class="dv">2</span>)<span class="op">$</span>cluster</span>
<span id="cb372-5"><a href="marker-detection.html#cb372-5" aria-hidden="true"></a>out &lt;-<span class="st"> </span><span class="kw">findMarkers</span>(y, clusters)</span>
<span id="cb372-6"><a href="marker-detection.html#cb372-6" aria-hidden="true"></a><span class="kw">hist</span>(out[[<span class="dv">1</span>]]<span class="op">$</span>p.value, <span class="dt">col=</span><span class="st">&quot;grey80&quot;</span>, <span class="dt">xlab=</span><span class="st">&quot;p-value&quot;</span>)</span></code></pre></div>
<div class="figure"><span id="fig:pval-dist"></span>
<img src="marker-detection_files/figure-html/pval-dist-1.png" alt="Distribution of $p$-values from a DE analysis between two clusters in a simulation with no true subpopulation structure." width="672" />
<p class="caption">
Figure 11.7: Distribution of <span class="math inline">\(p\)</span>-values from a DE analysis between two clusters in a simulation with no true subpopulation structure.
</p>
</div>
<p>For marker gene detection, this effect is largely harmless as the <span class="math inline">\(p\)</span>-values are used only for ranking.
However, it becomes an issue when the <span class="math inline">\(p\)</span>-values are used to define “significant differences” between clusters with respect to an error rate threshold.
Meaningful interpretation of error rates require consideration of the long-run behavior, i.e., the rate of incorrect rejections if the experiment were repeated many times.
The concept of statistical significance for differences between clusters is not applicable if clusters and their interpretations are not stably reproducible across (hypothetical) replicate experiments.</p>
</div>
<div id="false-replicates" class="section level3" number="11.5.2">
<h3><span class="header-section-number">11.5.2</span> Nature of replication</h3>
<p>The naive application of DE analysis methods will treat counts from the same cluster of cells as replicate observations.
This is not the most relevant level of replication when cells are derived from the same biological sample (i.e., cell culture, animal or patient).
DE analyses that treat cells as replicates fail to properly model the sample-to-sample variability <span class="citation">(A. T. L. Lun and Marioni <a href="#ref-lun2017overcoming" role="doc-biblioref">2017</a>)</span>.
The latter is arguably the more important level of replication as different samples will necessarily be generated if the experiment is to be replicated.
Indeed, the use of cells as replicates only masks the fact that the sample size is actually one in an experiment involving a single biological sample.
This reinforces the inappropriateness of using the marker gene <span class="math inline">\(p\)</span>-values to perform statistical inference.</p>
<p>We strongly recommend selecting some markers for use in validation studies with an independent replicate population of cells.
A typical strategy is to identify a corresponding subset of cells that express the upregulated markers and do not express the downregulated markers.
Ideally, a different technique for quantifying expression would also be used during validation, e.g., fluorescent <em>in situ</em> hybridisation or quantitative PCR.
This confirms that the subpopulation genuinely exists and is not an artifact of the scRNA-seq protocol or the computational analysis.</p>
</div>
</div>
<div id="further-comments" class="section level2" number="11.6">
<h2><span class="header-section-number">11.6</span> Further comments</h2>
<p>One consequence of the DE analysis strategy is that markers are defined relative to subpopulations in the same dataset.
Biologically meaningful genes will not be detected if they are expressed uniformly throughout the population, e.g., T cell markers will not be detected if only T cells are present in the dataset.
In practice, this is usually only a problem when the experimental data are provided without any biological context - certainly, we would hope to have some <em>a priori</em> idea about what cells have been captured.
For most applications, it is actually desirable to avoid detecting such genes as we are interested in characterizing heterogeneity within the context of a known cell population.
Continuing from the example above, the failure to detect T cell markers is of little consequence if we already know we are working with T cells.
Nonetheless, if “absolute” identification of cell types is necessary, we discuss some strategies for doing so in Chapter <a href="cell-type-annotation.html#cell-type-annotation">12</a>.</p>
<p>Alternatively, marker detection can be performed by treating gene expression as a predictor variable for cluster assignment.
For a pair of clusters, we can find genes that discriminate between them by performing inference with a logistic model where the outcome for each cell is whether it was assigned to the first cluster and the lone predictor is the expression of each gene.
Treating the cluster assignment as the dependent variable is more philosophically pleasing in some sense, as the clusters are indeed defined from the expression data rather than being known in advance.
(Note that this does not solve the data snooping problem.)
In practice, this approach effectively does the same task as a Wilcoxon rank sum test in terms of quantifying separation between clusters.
Logistic models have the advantage in that they can easily be extended to block on multiple nuisance variables, though this is not typically necessary in most use cases.
Even more complex strategies use machine learning methods to determine which features contribute most to successful cluster classification, but this is probably unnecessary for routine analyses.</p>
</div>
<div id="session-info" class="section level2 unnumbered">
<h2>Session Info</h2>
<button class="rebook-collapse">
View session info
</button>
<div class="rebook-content">
<pre><code>R version 4.0.0 Patched (2020-05-01 r78341)
Platform: x86_64-pc-linux-gnu (64-bit)
Running under: Ubuntu 18.04.5 LTS

Matrix products: default
BLAS:   /home/luna/Software/R/R-4-0-branch-dev/lib/libRblas.so
LAPACK: /home/luna/Software/R/R-4-0-branch-dev/lib/libRlapack.so

locale:
 [1] LC_CTYPE=en_US.UTF-8       LC_NUMERIC=C              
 [3] LC_TIME=en_US.UTF-8        LC_COLLATE=en_US.UTF-8    
 [5] LC_MONETARY=en_US.UTF-8    LC_MESSAGES=en_US.UTF-8   
 [7] LC_PAPER=en_US.UTF-8       LC_NAME=C                 
 [9] LC_ADDRESS=C               LC_TELEPHONE=C            
[11] LC_MEASUREMENT=en_US.UTF-8 LC_IDENTIFICATION=C       

attached base packages:
[1] parallel  stats4    stats     graphics  grDevices utils     datasets 
[8] methods   base     

other attached packages:
 [1] limma_3.45.10               scater_1.17.4              
 [3] ggplot2_3.3.2               pheatmap_1.0.12            
 [5] scran_1.17.15               SingleCellExperiment_1.11.6
 [7] SummarizedExperiment_1.19.6 DelayedArray_0.15.7        
 [9] matrixStats_0.56.0          Matrix_1.2-18              
[11] Biobase_2.49.0              GenomicRanges_1.41.6       
[13] GenomeInfoDb_1.25.10        IRanges_2.23.10            
[15] S4Vectors_0.27.12           BiocGenerics_0.35.4        
[17] BiocStyle_2.17.0            rebook_0.99.4              

loaded via a namespace (and not attached):
 [1] viridis_0.5.1             edgeR_3.31.4             
 [3] BiocSingular_1.5.0        viridisLite_0.3.0        
 [5] DelayedMatrixStats_1.11.1 scuttle_0.99.13          
 [7] statmod_1.4.34            BiocManager_1.30.10      
 [9] highr_0.8                 dqrng_0.2.1              
[11] vipor_0.4.5               GenomeInfoDbData_1.2.3   
[13] yaml_2.2.1                pillar_1.4.6             
[15] lattice_0.20-41           glue_1.4.1               
[17] digest_0.6.25             RColorBrewer_1.1-2       
[19] XVector_0.29.3            colorspace_1.4-1         
[21] cowplot_1.0.0             htmltools_0.5.0          
[23] XML_3.99-0.5              pkgconfig_2.0.3          
[25] bookdown_0.20             zlibbioc_1.35.0          
[27] purrr_0.3.4               scales_1.1.1             
[29] processx_3.4.3            BiocParallel_1.23.2      
[31] tibble_3.0.3              farver_2.0.3             
[33] generics_0.0.2            ellipsis_0.3.1           
[35] withr_2.2.0               magrittr_1.5             
[37] crayon_1.3.4              CodeDepends_0.6.5        
[39] evaluate_0.14             ps_1.3.4                 
[41] bluster_0.99.1            beeswarm_0.2.3           
[43] graph_1.67.1              tools_4.0.0              
[45] lifecycle_0.2.0           stringr_1.4.0            
[47] munsell_0.5.0             locfit_1.5-9.4           
[49] irlba_2.3.3               callr_3.4.3              
[51] compiler_4.0.0            rsvd_1.0.3               
[53] rlang_0.4.7               grid_4.0.0               
[55] RCurl_1.98-1.2            BiocNeighbors_1.7.0      
[57] igraph_1.2.5              labeling_0.3             
[59] bitops_1.0-6              rmarkdown_2.3            
[61] gtable_0.3.0              codetools_0.2-16         
[63] R6_2.4.1                  gridExtra_2.3            
[65] knitr_1.29                dplyr_1.0.1              
[67] ggbeeswarm_0.6.0          stringi_1.4.6            
[69] Rcpp_1.0.5                vctrs_0.3.2              
[71] tidyselect_1.1.0          xfun_0.16                </code></pre>
</div>

</div>
</div>
<h3> Bibliography</h3>
<div id="refs" class="references">
<div id="ref-berger1996bioequivalence">
<p>Berger, R. L., and J. C. Hsu. 1996. “Bioequivalence Trials, Intersection-Union Tests and Equivalence Confidence Sets.” <em>Statist. Sci.</em> 11 (4): 283–319. <a href="https://doi.org/10.1214/ss/1032280304">https://doi.org/10.1214/ss/1032280304</a>.</p>
</div>
<div id="ref-law2014voom">
<p>Law, C. W., Y. Chen, W. Shi, and G. K. Smyth. 2014. “voom: Precision weights unlock linear model analysis tools for RNA-seq read counts.” <em>Genome Biol.</em> 15 (2): R29.</p>
</div>
<div id="ref-lawlor2017singlecell">
<p>Lawlor, N., J. George, M. Bolisetty, R. Kursawe, L. Sun, V. Sivakamasundari, I. Kycia, P. Robson, and M. L. Stitzel. 2017. “Single-cell transcriptomes identify human islet cell signatures and reveal cell-type-specific expression changes in type 2 diabetes.” <em>Genome Res.</em> 27 (2): 208–22.</p>
</div>
<div id="ref-lun2017overcoming">
<p>Lun, A. T. L., and J. C. Marioni. 2017. “Overcoming confounding plate effects in differential expression analyses of single-cell RNA-seq data.” <em>Biostatistics</em> 18 (3): 451–64.</p>
</div>
<div id="ref-mccarthy2009treat">
<p>McCarthy, D. J., and G. K. Smyth. 2009. “Testing significance relative to a fold-change threshold is a TREAT.” <em>Bioinformatics</em> 25 (6): 765–71.</p>
</div>
<div id="ref-ritchie2015limma">
<p>Ritchie, M. E., B. Phipson, D. Wu, Y. Hu, C. W. Law, W. Shi, and G. K. Smyth. 2015. “limma powers differential expression analyses for RNA-sequencing and microarray studies.” <em>Nucleic Acids Res.</em> 43 (7): e47.</p>
</div>
<div id="ref-simes1986improved">
<p>Simes, R. J. 1986. “An Improved Bonferroni Procedure for Multiple Tests of Significance.” <em>Biometrika</em> 73 (3): 751–54.</p>
</div>
<div id="ref-soneson2018bias">
<p>Soneson, C., and M. D. Robinson. 2018. “Bias, robustness and scalability in single-cell differential expression analysis.” <em>Nat. Methods</em> 15 (4): 255–61.</p>
</div>
</div>
<div class="footnotes">
<hr />
<ol start="2">
<li id="fn2"><p>Standard operating procedure is to (i) experience a brief but crushing bout of disappointment due to the poor quality of upregulated candidate markers, (ii) rage-quit, and (iii) remember to check the genes that are changing in the other direction.<a href="marker-detection.html#fnref2" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="clustering.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="cell-type-annotation.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/Bioconductor/OrchestratingSingleCellAnalysis-base/edit/master/marker-detection.Rmd",
"text": "Edit"
},
"history": {
"link": "https://github.com/Bioconductor/OrchestratingSingleCellAnalysis-base/commits/master/marker-detection.Rmd",
"text": null
},
"view": {
"link": "https://github.com/Bioconductor/OrchestratingSingleCellAnalysis-base/blob/master/marker-detection.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
